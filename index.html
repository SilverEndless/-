<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>æ•…äº‹å¤§çº²ç®¡ç†å™¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { 
            height: 100vh;
            overflow: hidden;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #ffb300 0%, #000000 100%);
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            width: 100%;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            color: white;
            flex-shrink: 0;
        }
        .title { font-size: 32px; font-weight: bold; }
        .btn-group { display: flex; gap: 10px; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-purple { background: #8b5cf6; color: white; }
        .btn-indigo { background: #6366f1; color: white; }
        
        .timeline-container {
            background: #1f2937;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .timeline-toolbar {
            background: #374151;
            padding: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        .timeline-toolbar .btn { padding: 8px 16px; font-size: 14px; }
        .timeline-toolbar span { color: white; font-weight: bold; }
        
        .timeline-canvas {
            background: #1f2937;
            overflow: auto;
            flex: 1;
            position: relative;
            min-height: 0;
        }
        .timeline-header {
            display: none;
        }
        .chapter-label {
            color: white;
            font-weight: bold;
            text-align: center;
            border-right: 1px solid #4b5563;
            padding: 10px;
        }
        .chapter-sublabel {
            color: #9ca3af;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .timeline-grid {
            min-height: 400px;
            position: relative;
            padding: 20px;
        }        
        /* åˆ†å±‚åŒºåŸŸæ ·å¼ */
        .hidden-layer-area {
            position: relative;
            background: linear-gradient(180deg, #7c3aed 0%, #6d28d9 50%, #5b21b6 100%);
            min-height: 400px;
            border-bottom: 5px solid #a78bfa;
        }
        
        .surface-layer-area {
            position: relative;
            background: linear-gradient(180deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
            min-height: 400px;
        }
        
        .layer-divider {
            position: sticky;
            top: 0;
            height: 100px;
            background: linear-gradient(90deg, #a855f7 0%, #8b5cf6 20%, #6366f1 40%, #3b82f6 60%, #0ea5e9 80%, #06b6d4 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            z-index: 20;
            box-shadow: 0 8px 16px rgba(0,0,0,0.6), 0 0 30px rgba(139, 92, 246, 0.5);
            border-top: 3px solid #e9d5ff;
            border-bottom: 3px solid #bae6fd;
            position: relative;
        }
        
        /* ä¸Šå±‚ï¼šç« èŠ‚åˆ»åº¦ */
        .top-scale {
            position: absolute;
            top: 5px;
            left: 0;
            right: 0;
            height: 20px;
            display: flex;
            align-items: center;
            font-size: 11px;
            color: rgba(255,255,255,0.9);
        }
        
        /* ä¸­å±‚ï¼šå¤©æ•°åˆ»åº¦ */
        .middle-scale {
            position: absolute;
            top: 28px;
            left: 0;
            right: 0;
            height: 24px;
            display: flex;
            align-items: center;
            font-size: 13px;
            font-weight: bold;
            color: white;
        }
        
        /* ä¸‹å±‚ï¼šç« èŠ‚åˆ»åº¦ */
        .bottom-scale {
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            height: 20px;
            display: flex;
            align-items: center;
            font-size: 11px;
            color: rgba(255,255,255,0.9);
        }
        
        .chapter-marker {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80px;
        }
        
        .day-marker {
            position: absolute;
            font-size: 11px;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: #fbbf24;
            white-space: nowrap;
            letter-spacing: 0px;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60px;
        }
        
        .layer-label {
            position: sticky;
            top: 5px;
            left: 5px;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 900;
            font-size: 16px;
            z-index: 100;
            display: inline-block;
            box-shadow: 0 2px 10px rgba(0,0,0,0.6);
            margin-bottom: 10px;
        }
        
        .hidden-layer-label {
            /* èƒŒæ™¯è‰²ç”±inline styleåŠ¨æ€è®¾ç½® */
            color: white;
            border: 3px solid rgba(255, 255, 255, 0.8);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            box-shadow: 0 2px 10px rgba(168, 85, 247, 0.6);
        }
        
        .surface-layer-label {
            /* èƒŒæ™¯è‰²ç”±inline styleåŠ¨æ€è®¾ç½® */
            color: white;
            border: 3px solid rgba(255, 255, 255, 0.8);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            box-shadow: 0 2px 10px rgba(14, 165, 233, 0.6);
        }

        .event-block {
            position: absolute;
            height: 70px;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            user-select: none;
        }
        .event-block.editable {
            cursor: grab;
        }
        .event-block:hover { transform: scaleY(1.05); z-index: 5; }
        .event-block.dragging {
            cursor: grabbing;
            opacity: 1.0;  /* å®Œå…¨ä¸é€æ˜ï¼Œä¿æŒåŸæ · */
            z-index: 100;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3); /* æ·»åŠ é˜´å½±è¡¨ç¤ºæ­£åœ¨æ‹–åŠ¨ */
            /* ä¸æ”¹å˜å¤§å°å’Œé€æ˜åº¦ï¼Œä¿æŒåŸå§‹å¤–è§‚ */
        }
        .event-block.selected { 
            border: 4px solid #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }
        .event-title {
            color: white;
            font-weight: bold;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .event-time {
            color: rgba(255,255,255,0.9);
            font-size: 12px;
            margin-top: 4px;
        }
        .event-tags {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            flex-wrap: wrap;
        }
        .event-tag {
            background: rgba(0,0,0,0.3);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }
        .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 16px;
            background: rgba(255,255,255,0.8);
            cursor: ew-resize;
            display: none;
            align-items: center;
            justify-content: center;
            border-left: 2px solid white;
        }
        .event-block.editable .resize-handle {
            display: flex;
        }
        .resize-handle:hover { background: white; }
        .resize-handle::before {
            content: 'â‹®';
            color: rgba(0,0,0,0.5);
            font-size: 18px;
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-size: 24px; font-weight: bold; color: #111827; }
        .modal-close {
            background: none;
            border: none;
            font-size: 32px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 32px;
            height: 32px;
            line-height: 32px;
        }
        .modal-close:hover { color: #111827; background: #f3f4f6; border-radius: 4px; }
        .modal-body { padding: 20px; }
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .form-group { margin-bottom: 15px; }
        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #111827;
        }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .info-box {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .info-box h3 {
            color: #111827;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .info-box p { color: #4b5563; line-height: 1.6; }
        
        .tag-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .tag-item {
            background: #dbeafe;
            color: #1e40af;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tag-remove {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #1e40af;
            padding: 0;
            line-height: 1;
        }
        .tag-input-group {
            display: flex;
            gap: 8px;
        }
        
        .hint { font-size: 12px; color: #6b7280; margin-top: 4px; }
        
        .timeline-hint {
            background: #374151;
            padding: 10px;
            text-align: center;
            color: #9ca3af;
            font-size: 14px;
            flex-shrink: 0;
        }
        .timeline-scale {
            background: #1f2937;
            border-top: 1px solid #4b5563;
            padding: 5px 20px;
            color: #9ca3af;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .chapter-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .chapter-item-view {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chapter-item-edit {
            display: none;
        }
        .chapter-item.editing .chapter-item-view {
            display: none;
        }
        .chapter-item.editing .chapter-item-edit {
            display: block;
        }
        .chapter-info h4 {
            font-weight: bold;
            color: #111827;
            margin-bottom: 5px;
        }
        .chapter-info p {
            color: #6b7280;
            font-size: 14px;
        }
        .tag-stat-item {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .tag-stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .tag-stat-name {
            font-weight: bold;
            color: #1e40af;
            cursor: pointer;
        }
        .tag-stat-name:hover {
            color: #1e3a8a;
        }
        .tag-stat-count {
            color: #6b7280;
            font-size: 14px;
        }
        .tag-stat-events {
            color: #4b5563;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .btn-sm { padding: 6px 12px; font-size: 14px; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
            
            .controls {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 14px;
                min-height: 44px; /* iOSæ¨èæœ€å°ç‚¹å‡»åŒºåŸŸ */
            }
            
            .btn-sm {
                padding: 8px 12px;
                font-size: 13px;
                min-height: 38px;
            }
            
            .event-block {
                min-width: 60px;
                font-size: 12px;
                padding: 8px;
            }
            
            .event-title {
                font-size: 13px;
            }
            
            .event-time {
                font-size: 11px;
            }
            
            .resize-handle {
                width: 20px; /* æ›´å¤§çš„è§¦æ‘¸åŒºåŸŸ */
                background: rgba(255, 255, 255, 0.8);
            }
            
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 20px auto;
            }
            
            .form-input, .form-select {
                font-size: 16px; /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
                padding: 12px;
            }
            
            .tag {
                padding: 6px 12px;
                font-size: 13px;
            }
            
            #tagInput, #eventTagInput {
                font-size: 16px;
                padding: 10px;
            }
            
            /* æ—¶é—´çº¿è°ƒæ•´ */
            #timelineCanvas {
                overflow-x: auto;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch; /* iOSå¹³æ»‘æ»šåŠ¨ */
            }
            
            /* è§¦æ‘¸å‹å¥½çš„æ ‡ç­¾ç®¡ç† */
            label[style*="cursor: pointer"] {
                padding: 12px !important;
                min-height: 44px;
            }
            
            /* æ›´å¤§çš„å¤é€‰æ¡† */
            input[type="checkbox"] {
                width: 22px !important;
                height: 22px !important;
                margin-right: 12px !important;
            }
            
            /* æ¨¡æ€æ¡†è°ƒæ•´ */
            .modal-header {
                padding: 16px;
            }
            
            .modal-body {
                padding: 16px;
            }
            
            .modal-footer {
                padding: 16px;
                gap: 10px;
            }
            
            .modal-close {
                width: 36px;
                height: 36px;
                font-size: 24px;
            }
        }
        
        /* å°å±å¹•æ‰‹æœº */
        @media (max-width: 480px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn, .btn-sm {
                width: 100%;
            }
            
            .event-block {
                font-size: 11px;
                padding: 6px;
            }
            
            .modal-content {
                width: 100%;
                height: 100%;
                max-width: 100%;
                margin: 0;
                border-radius: 0;
            }
        }
        
        /* è§¦æ‘¸è®¾å¤‡é€šç”¨æ ·å¼ */
        @media (hover: none) and (pointer: coarse) {
            /* ç§»é™¤hoveræ•ˆæœï¼Œå› ä¸ºè§¦æ‘¸è®¾å¤‡æ²¡æœ‰çœŸæ­£çš„hover */
            .event-block:hover {
                transform: none;
            }
            
            /* å¢å¤§æ‰€æœ‰å¯ç‚¹å‡»å…ƒç´  */
            button, a, .tag button {
                min-height: 44px;
                min-width: 44px;
            }
        }
        

        /* æ ¼å­èƒŒæ™¯ - æš—å±‚ */
        .hidden-layer-area {
            background-color: #1e1b4b;
            background-image: 
                repeating-linear-gradient(90deg, 
                    transparent 0, 
                    transparent calc(var(--chapter-width, 50px) - 2px), 
                    rgba(139, 92, 246, 0.3) calc(var(--chapter-width, 50px) - 2px), 
                    rgba(139, 92, 246, 0.3) var(--chapter-width, 50px)
                ),
                repeating-linear-gradient(90deg, 
                    transparent 0, 
                    transparent calc(var(--day-width, 10px) - 1px), 
                    rgba(139, 92, 246, 0.1) calc(var(--day-width, 10px) - 1px), 
                    rgba(139, 92, 246, 0.1) var(--day-width, 10px)
                );
        }
        
        /* æ ¼å­èƒŒæ™¯ - è¡¨å±‚ */
        .surface-layer-area {
            background-color: #0c4a6e;
            background-image: 
                repeating-linear-gradient(90deg, 
                    transparent 0, 
                    transparent calc(var(--chapter-width, 50px) - 2px), 
                    rgba(14, 165, 233, 0.3) calc(var(--chapter-width, 50px) - 2px), 
                    rgba(14, 165, 233, 0.3) var(--chapter-width, 50px)
                ),
                repeating-linear-gradient(90deg, 
                    transparent 0, 
                    transparent calc(var(--day-width, 10px) - 1px), 
                    rgba(14, 165, 233, 0.1) calc(var(--day-width, 10px) - 1px), 
                    rgba(14, 165, 233, 0.1) var(--day-width, 10px)
                );
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">ğŸ“– æ•…äº‹å¤§çº²ç®¡ç†å™¨ v1.0</div>
            <div class="btn-group">
                <button class="btn btn-purple" onclick="exportData()">ğŸ“¥ å¯¼å‡º</button>
                <label class="btn btn-indigo" style="margin: 0;">
                    ğŸ“¤ å¯¼å…¥
                    <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                </label>
                <button class="btn btn-primary" id="editModeBtn" onclick="toggleEditMode()">âœ ç¼–è¾‘</button>
            </div>
        </div>
        
        <div class="timeline-container">
            <div class="timeline-toolbar">
                <button class="btn btn-secondary btn-sm" onclick="zoomOut()">ğŸ”âˆ’</button>
                <input type="number" 
                       id="zoomInput" 
                       value="100" 
                       min="10" 
                       max="500" 
                       step="5"
                       onchange="setZoom(parseInt(this.value) || 100)"
                       style="width: 70px; padding: 4px 8px; border: 1px solid #4b5563; border-radius: 4px; background: #1f2937; color: white; text-align: center;">
                <span style="color: white;">%</span>
                <button class="btn btn-secondary btn-sm" onclick="zoomIn()">ğŸ”+</button>
                
                <button class="btn btn-secondary btn-sm" onclick="showDayManager()">âš™ï¸ å¤©æ•°ç®¡ç†</button>
                <button class="btn btn-secondary btn-sm" onclick="showTagManager()">ğŸ·ï¸ æ ‡ç­¾ç®¡ç†</button>
                <button class="btn btn-secondary btn-sm" onclick="showColorCustomizer()">ğŸ¨ é¢œè‰²è®¾ç½®</button>
                
                <button class="btn btn-success btn-sm" id="addEventBtn" onclick="showAddEventForm()" style="margin-left: auto; display: none;">â• æ·»åŠ äº‹ä»¶</button>
            </div>
            
            <div class="timeline-canvas" id="timelineCanvas">
                <div class="timeline-header" id="timelineHeader"></div>
                <div class="timeline-grid" id="timelineGrid"></div>
            </div>
            
            <div class="timeline-scale" id="timelineScale">
                <span id="scaleStart">åº5</span>
                <span id="scaleEnd">ç¬¬100ç« </span>
            </div>
            
            <div class="timeline-hint" id="timelineHint">
                ç‚¹å‡»äº‹ä»¶æŸ¥çœ‹è¯¦æƒ…
            </div>
        </div>
    </div>
    
    <!-- Event Detail Modal -->
    <div class="modal" id="eventDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="eventDetailTitle"></div>
                <button class="modal-close" onclick="closeEventDetail()">Ã—</button>
            </div>
            <div class="modal-body" id="eventDetailBody"></div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="editEvent()">âœï¸ ç¼–è¾‘</button>
                <button class="btn btn-danger" id="deleteEventBtn" onclick="deleteEvent()" style="display: none;">ğŸ—‘ï¸ åˆ é™¤</button>
            </div>
        </div>
    </div>
    

    <!-- Causal Chain Modal -->
    <div class="modal" id="causalChainModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">ğŸ” å®Œæ•´å› æœé“¾</div>
                <button class="modal-close" onclick="closeCausalChain()">Ã—</button>
            </div>
            <div class="modal-body" id="causalChainBody" style="max-height: 600px; overflow-y: auto;">
                <!-- å› æœé“¾å†…å®¹ -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCausalChain()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- Event Form Modal -->
    <div class="modal" id="eventFormModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="eventFormTitle">æ·»åŠ äº‹ä»¶</div>
                <button class="modal-close" onclick="closeEventForm()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="form-group">
                        <label class="form-label">äº‹ä»¶æ ‡é¢˜</label>
                        <input type="text" class="form-input" id="eventTitle" placeholder="è¾“å…¥äº‹ä»¶æ ‡é¢˜">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å›¾æ ‡Emojiï¼ˆå¯é€‰ï¼‰</label>
                        <input type="text" class="form-input" id="eventEmoji" placeholder="è¾“å…¥emojiï¼Œå¦‚ï¼šğŸ‰ ğŸ”¥ â­ ğŸ’¡ï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰" maxlength="2">
                        <div class="hint">æ˜¾ç¤ºåœ¨äº‹ä»¶æ ‡é¢˜å‰é¢ï¼Œç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤å›¾æ ‡ï¼ˆæš—å±‚ğŸŒ‘ è¡¨å±‚â˜€ï¸ï¼‰</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è¯¦ç»†æè¿°</label>
                        <textarea class="form-textarea" id="eventDescription" placeholder="è¯¦ç»†æè¿°äº‹ä»¶å†…å®¹"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">èµ·å§‹ç« èŠ‚ï¼ˆç¬¬å‡ ç« ï¼‰</label>
                            <input type="number" class="form-input" id="eventStartTime" value="1" min="1" onchange="updateDayHint()">
                            <div class="hint" id="chapterHint">ä¿®æ”¹æ­¤å€¼å¯ä»¥æ”¹å˜äº‹ä»¶çš„èµ·å§‹ç« èŠ‚</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æŒç»­ç« èŠ‚ï¼ˆç« æ•°ï¼‰</label>
                            <input type="number" class="form-input" id="eventDuration" value="2" min="1">
                            <div class="hint">ä¿®æ”¹æ­¤å€¼å¯ä»¥æ”¹å˜äº‹ä»¶çš„é•¿åº¦</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è¡Œä½ç½®ï¼ˆlayerï¼‰</label>
                        <input type="number" class="form-input" id="eventLayer" value="0" min="0">
                        <div class="hint">æç¤ºï¼šè¡Œä½ç½®å†³å®šäº‹ä»¶çš„å‚ç›´ä½ç½®ï¼Œ0åœ¨æœ€ä¸Šæ–¹ï¼ˆç« èŠ‚èŒƒå›´å¤§çš„äº‹ä»¶å»ºè®®æ”¾åœ¨ä¸Šæ–¹ï¼‰</div>
                    </div>
                    

                    <div class="form-group">
                        <label class="form-label">æ ‡ç­¾</label>
                        <div class="tag-list" id="eventTagsList"></div>
                        <div class="tag-input-group">
                            <input type="text" class="form-input" id="eventTagInput" placeholder="è¾“å…¥æ ‡ç­¾ï¼ŒæŒ‰å›è½¦æ·»åŠ ">
                            <button type="button" class="btn btn-primary btn-sm" onclick="addTag()">æ·»åŠ </button>
                        </div>
                        
                        <div style="margin-top: 12px;">
                            <label style="font-size: 13px; color: #6b7280; margin-bottom: 6px; display: block;">ğŸ’¡ å¿«é€Ÿé€‰æ‹©æ ‡ç­¾ï¼š</label>
                            <div id="availableTagsList" style="display: flex; flex-wrap: wrap; gap: 6px; padding: 10px; background: #f9fafb; border-radius: 8px; min-height: 40px;">
                                <!-- å¯é€‰æ ‡ç­¾åˆ—è¡¨ -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- å› æœå…³è” -->
                    <div class="form-group" style="border-top: 2px solid #e5e7eb; padding-top: 20px; margin-top: 20px;">
                        <label class="form-label" style="font-size: 16px; font-weight: bold;">ğŸ”— å› æœå…³è”</label>
                        
                        <!-- èµ·å›  -->
                        <div style="margin-bottom: 16px;">
                            <label style="font-size: 14px; color: #374151; display: block; margin-bottom: 8px;">â¬…ï¸ èµ·å› ï¼ˆå¯¼è‡´æ­¤äº‹ä»¶å‘ç”Ÿçš„åŸå› ï¼‰</label>
                            <div id="causesList" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 40px; padding: 8px; background: #fef3c7; border-radius: 6px; margin-bottom: 8px;">
                                <!-- èµ·å› äº‹ä»¶åˆ—è¡¨ -->
                            </div>
                            <select class="form-select" id="causeSelect" onchange="addCause()" style="margin-top: 8px;">
                                <option value="">+ æ·»åŠ èµ·å› äº‹ä»¶</option>
                            </select>
                        </div>
                        
                        <!-- ç»“æœ -->
                        <div>
                            <label style="font-size: 14px; color: #374151; display: block; margin-bottom: 8px;">â¡ï¸ ç»“æœï¼ˆæ­¤äº‹ä»¶å¯¼è‡´çš„åæœï¼‰</label>
                            <div id="effectsList" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 40px; padding: 8px; background: #dbeafe; border-radius: 6px; margin-bottom: 8px;">
                                <!-- ç»“æœäº‹ä»¶åˆ—è¡¨ -->
                            </div>
                            <select class="form-select" id="effectSelect" onchange="addEffect()" style="margin-top: 8px;">
                                <option value="">+ æ·»åŠ ç»“æœäº‹ä»¶</option>
                            </select>
                        </div>
                        
                        <div class="hint" style="margin-top: 12px;">
                            ğŸ’¡ æç¤ºï¼šå»ºç«‹å› æœå…³ç³»åï¼Œç‚¹å‡»äº‹ä»¶å¯ä»¥æŸ¥çœ‹å®Œæ•´çš„å› æœé“¾
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEventForm()">âŒ å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveEvent()">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Day Manager Modal -->
    <div class="modal" id="chapterManagerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">âš™ï¸ å¤©æ•°ç®¡ç†</div>
                <button class="modal-close" onclick="closeDayManager()">Ã—</button>
            </div>
            <div class="modal-body">
                <!-- è‡ªåŠ¨ç”ŸæˆæŒ‰é’® -->
                <div style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px;">
                    <div style="color: white; font-weight: bold; margin-bottom: 10px; font-size: 16px;">ğŸš€ å¿«é€Ÿç”Ÿæˆå¤©æ•°</div>
                    <div style="color: rgba(255,255,255,0.9); font-size: 13px; margin-bottom: 12px;">
                        è‡ªå®šä¹‰è§„åˆ™æ‰¹é‡ç”Ÿæˆå¤©æ•°æ®µ
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                        <div style="display: grid; gap: 10px;">
                            <div>
                                <label style="color: white; font-size: 13px; display: block; margin-bottom: 5px;">ä»ç¬¬å‡ å¤©å¼€å§‹ï¼š</label>
                                <input type="number" id="autoStartDay" value="1" min="1" class="form-input" style="width: 100%;">
                            </div>
                            <div>
                                <label style="color: white; font-size: 13px; display: block; margin-bottom: 5px;">ä¸€å¤©åŒ…å«å‡ ç« ï¼š</label>
                                <input type="number" id="autoChaptersPerDay" value="1" min="1" class="form-input" style="width: 100%;">
                            </div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 12px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                                ğŸ’¡ ä¾‹å¦‚ï¼šä»ç¬¬1å¤©å¼€å§‹ï¼Œæ¯å¤©1ç« <br>
                                â†’ ç¬¬1ç« =ç¬¬1å¤©ï¼Œç¬¬2ç« =ç¬¬2å¤©<br><br>
                                ä¾‹å¦‚ï¼šä»ç¬¬5å¤©å¼€å§‹ï¼Œæ¯å¤©2ç« <br>
                                â†’ ç¬¬1-2ç« =ç¬¬5å¤©ï¼Œç¬¬3-4ç« =ç¬¬6å¤©
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="autoGenerateDaysCustom()" style="width: 100%;">
                        âš¡ å¼€å§‹è‡ªåŠ¨ç”Ÿæˆ
                    </button>
                </div>
                
                <div id="chapterList"></div>
                
                <div style="border-top: 2px solid #e5e7eb; margin-top: 20px; padding-top: 20px;">
                    <h3 style="font-weight: bold; margin-bottom: 15px; color: #111827;">æ·»åŠ æ–°å¤©æ•°</h3>
                    <div class="info-box" style="background: #e0f2fe; border: 1px solid #0284c7; margin-bottom: 15px;">
                        <p style="color: #0c4a6e; font-size: 13px; margin: 0;">
                            ğŸ’¡ <strong>æç¤ºï¼š</strong>ç« èŠ‚æ˜¾ç¤ºè§„åˆ™<br>
                            â€¢ è´Ÿæ•°æ˜¾ç¤ºä¸º"åºX"ï¼ˆ-5æ˜¾ç¤ºä¸º"åº5"ï¼‰<br>
                            â€¢ 0æ˜¾ç¤ºä¸º"åºç« "<br>
                            â€¢ æ­£æ•°æ˜¾ç¤ºä¸º"ç¬¬Xç« "ï¼ˆ5æ˜¾ç¤ºä¸º"ç¬¬5ç« "ï¼‰<br>
                            â€¢ æ”¯æŒå€’åºå†™ä½œï¼ˆå¦‚ç¬¬100ç« åˆ°ç¬¬90ç« ï¼‰<br>
                            â€¢ <strong style="color: #dc2626;">âš ï¸ ç« èŠ‚èŒƒå›´ä¸èƒ½é‡å </strong>
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¤©æ•°åç§°</label>
                        <input type="text" class="form-input" id="newChapterName" placeholder="ä¾‹å¦‚ï¼šç¬¬1å¤©">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">èµ·å§‹ç« èŠ‚</label>
                            <input type="number" class="form-input" id="newChapterStart" value="1">
                            <div class="hint">å¯ä»¥æ˜¯ä»»æ„æ•°å­—ï¼ˆæ”¯æŒè´Ÿæ•°ã€å€’åºï¼‰</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç»“æŸç« èŠ‚</label>
                            <input type="number" class="form-input" id="newChapterEnd" value="1">
                            <div class="hint">ä¸èµ·å§‹ç« èŠ‚ç›¸åŒ=ä¸€ç« ä¸€å¤©ï¼Œå¤§äºèµ·å§‹ç« èŠ‚=å¤šç« ä¸€å¤©</div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addDay()" style="width: 100%;">â• æ·»åŠ å¤©æ•°</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDayManager()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- Tag Manager Modal -->
    <div class="modal" id="tagManagerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ·ï¸ æ ‡ç­¾ç®¡ç†</div>
                <button class="modal-close" onclick="closeTagManager()">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="border-bottom: 2px solid #e5e7eb; margin-bottom: 20px; padding-bottom: 20px;">
                    <h3 style="font-weight: bold; margin-bottom: 15px; color: #111827;">åˆ›å»ºæ–°æ ‡ç­¾</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                        <input type="text" class="form-input" id="newTagInput" placeholder="è¾“å…¥æ–°æ ‡ç­¾åç§°ï¼ˆè‡ªåŠ¨æ·»åŠ #ï¼‰" style="flex: 1;">
                        <button class="btn btn-success" onclick="createNewTag()">â• åˆ›å»ºæ ‡ç­¾</button>
                    </div>
                    
                    <div style="margin-top: 12px;">
                        <label style="font-weight: bold; display: block; margin-bottom: 8px;">é€‰æ‹©è¦æ·»åŠ æ­¤æ ‡ç­¾çš„äº‹ä»¶ï¼š</label>
                        <div id="eventCheckboxList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px;">
                            <!-- äº‹ä»¶å¤é€‰æ¡†åˆ—è¡¨ -->
                        </div>
                    </div>
                    
                    <div class="hint" style="margin-top: 8px;">å‹¾é€‰äº‹ä»¶åï¼Œåˆ›å»ºçš„æ ‡ç­¾ä¼šè‡ªåŠ¨æ·»åŠ åˆ°è¿™äº›äº‹ä»¶ä¸Š</div>
                </div>
                
                <div id="tagManagerBody"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTagManager()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡† -->
    <div id="customConfirm" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); color: white;">
                <div class="modal-title">âš ï¸ ç¡®è®¤åˆ é™¤</div>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" style="font-size: 16px; line-height: 1.6; color: #111827; margin: 0;"></p>
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="cancelConfirm()" style="flex: 1;">âŒ å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="confirmDelete()" style="flex: 1;">âœ… ç¡®å®šåˆ é™¤</button>
            </div>
        </div>
    </div>

        </div>

    <!-- é¢œè‰²è‡ªå®šä¹‰é¢æ¿ -->
    <div class="modal" id="colorCustomizer" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">ğŸ¨ é¢œè‰²è‡ªå®šä¹‰</div>
                <button class="modal-close" onclick="closeColorCustomizer()">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 20px;">
                    <!-- èƒŒæ™¯é¢œè‰² -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 16px;">ğŸŒŒ ç½‘é¡µèƒŒæ™¯</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="color" id="bgColor" value="#111827" onchange="updateColors()" style="width: 60px; height: 40px; border: 2px solid #4b5563; border-radius: 6px; cursor: pointer;">
                            <input type="text" id="bgImage" placeholder="æˆ–è¾“å…¥å›¾ç‰‡URL" class="form-input" style="flex: 1;" onchange="updateColors()">
                        </div>
                    </div>
                    
                    <!-- æš—å±‚é¢œè‰² -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 16px;">ğŸŒ‘ æš—å±‚èƒŒæ™¯</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="color" id="hiddenColor" value="#1e1b4b" onchange="updateColors()" style="width: 60px; height: 40px; border: 2px solid #4b5563; border-radius: 6px; cursor: pointer;">
                            <input type="text" id="hiddenImage" placeholder="æˆ–è¾“å…¥å›¾ç‰‡URL" class="form-input" style="flex: 1;" onchange="updateColors()">
                        </div>
                    </div>
                    
                    <!-- è¡¨å±‚é¢œè‰² -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 16px;">â˜€ï¸ è¡¨å±‚èƒŒæ™¯</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="color" id="surfaceColor" value="#0c4a6e" onchange="updateColors()" style="width: 60px; height: 40px; border: 2px solid #4b5563; border-radius: 6px; cursor: pointer;">
                            <input type="text" id="surfaceImage" placeholder="æˆ–è¾“å…¥å›¾ç‰‡URL" class="form-input" style="flex: 1;" onchange="updateColors()">
                        </div>
                    </div>
                    
                    <!-- æš—å±‚äº‹ä»¶é¢œè‰² -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 16px;">ğŸŒ‘ æš—å±‚äº‹ä»¶é¢œè‰²</label>
                        <input type="color" id="hiddenEventColor" value="#a855f7" onchange="updateColors()" style="width: 100px; height: 40px; border: 2px solid #4b5563; border-radius: 6px; cursor: pointer;">
                    </div>
                    
                    <!-- è¡¨å±‚äº‹ä»¶é¢œè‰² -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 16px;">â˜€ï¸ è¡¨å±‚äº‹ä»¶é¢œè‰²</label>
                        <input type="color" id="surfaceEventColor" value="#3b82f6" onchange="updateColors()" style="width: 100px; height: 40px; border: 2px solid #4b5563; border-radius: 6px; cursor: pointer;">
                    </div>
                    
                    <!-- æ ¼å­çº¿é¢œè‰² -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 16px;">ğŸ“ æ ¼å­çº¿é¢œè‰²</label>
                        <input type="color" id="gridColor" value="#8b5cf6" onchange="updateColors()" style="width: 100px; height: 40px; border: 2px solid #4b5563; border-radius: 6px; cursor: pointer;">
                    </div>
                    
                    <!-- æ—¶é—´æ¡èƒŒæ™¯é¢œè‰² -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 16px;">â±ï¸ æ—¶é—´æ¡èƒŒæ™¯é¢œè‰²</label>
                        <input type="color" id="dividerBgColor" value="#8b5cf6" onchange="updateColors()" style="width: 100px; height: 40px; border: 2px solid #4b5563; border-radius: 6px; cursor: pointer;">
                    </div>
                    
                    <!-- æ ¼å­çº¿é€æ˜åº¦ -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 16px;">ğŸ“ æ ¼å­çº¿é€æ˜åº¦</label>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <input type="range" id="gridOpacity" min="0" max="100" value="30" onchange="updateColors()" style="flex: 1;">
                            <span id="opacityValue" style="font-weight: bold; font-size: 18px; min-width: 50px;">30%</span>
                        </div>
                    </div>
                    
                    <!-- åˆ†éš”çº¿é¢œè‰² -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 16px;">â– åˆ†éš”çº¿é¢œè‰²</label>
                        <input type="color" id="dividerColor" value="#a78bfa" onchange="updateColors()" style="width: 100px; height: 40px; border: 2px solid #4b5563; border-radius: 6px; cursor: pointer;">
                    </div>
                    
                    <!-- ç« èŠ‚åˆ»åº¦é¢œè‰² -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 16px;">ğŸ“– ç« èŠ‚åˆ»åº¦é¢œè‰²</label>
                        <input type="color" id="chapterScaleColor" value="#d8b4fe" onchange="updateColors()" style="width: 100px; height: 40px; border: 2px solid #4b5563; border-radius: 6px; cursor: pointer;">
                    </div>
                    
                    <!-- å¤©æ•°åˆ»åº¦é¢œè‰² -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 16px;">ğŸ“… å¤©æ•°åˆ»åº¦é¢œè‰²</label>
                        <input type="color" id="dayScaleColor" value="#fbbf24" onchange="updateColors()" style="width: 100px; height: 40px; border: 2px solid #4b5563; border-radius: 6px; cursor: pointer;">
                    </div>
                    
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="saveColors()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                        <button class="btn btn-secondary" onclick="resetColors()">ğŸ”„ æ¢å¤é»˜è®¤</button>
                        <button class="btn btn-secondary" onclick="closeColorCustomizer()">å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let editMode = false;
        let zoom = 100;
        let selectedEvent = null;
        let editingEvent = null;
        let currentTags = [];
        let currentCauses = [];  // å½“å‰ç¼–è¾‘çš„èµ·å› 
        let currentEffects = []; // å½“å‰ç¼–è¾‘çš„ç»“æœ
        let draggingEvent = null;
        let dragOffset = { x: 0, y: 0 };
        let hasDragged = false;
        let originalLayer = null; // è®°å½•æ‹–åŠ¨å‰çš„åŸå§‹å±‚
        let initialMousePos = { x: 0, y: 0 }; // è®°å½•åˆå§‹é¼ æ ‡ä½ç½®
        let initialEventPos = { startTime: 0, layer: 0 }; // è®°å½•åˆå§‹äº‹ä»¶ä½ç½®
        let resizingEvent = null;
        let filteredTag = null; // å½“å‰ç­›é€‰çš„æ ‡ç­¾
        let globalTagLibrary = new Set(); // å…¨å±€æ ‡ç­¾åº“ï¼ŒåŒ…å«æ‰€æœ‰åˆ›å»ºè¿‡çš„æ ‡ç­¾
        
        let events = [
            { id: 't1', title: 'å‘¨æ˜ç‘æˆä¸ºè¯¡ç§˜ä¹‹ä¸»', description: 'æ•´ä¸ªæ•…äº‹çš„æ ¸å¿ƒçº¿ï¼Œè´¯ç©¿å…¨æ–‡',
              startTime: 1, duration: 100, layer: 0, color: 'rgb(147, 51, 234)', tags: ['#å…¨å±€', '#ä¸»çº¿'] },
            { id: 't2', title: 'ç©¿è¶Šè§‰é†’', description: 'å‘¨æ˜ç‘ç©¿è¶Šåˆ°500åœ°çƒï¼Œè·å¾—ç³»ç»Ÿ',
              startTime: 1, duration: 2, layer: 1, color: 'rgb(59, 130, 246)', tags: ['#å¼€å±€', '#ç©¿è¶Š', '#å»·æ ¹'] },
            { id: 't3', title: 'åŠ å…¥å€¼å¤œè€…', description: 'é€šè¿‡æµ‹è¯•ï¼Œæˆä¸ºå€¼å¤œè€…',
              startTime: 6, duration: 3, layer: 1, color: 'rgb(34, 197, 94)', tags: ['#å€¼å¤œè€…', '#å»·æ ¹'] },
            { id: 't4', title: 'ä¸‰ä»¶å¥—è·å–', description: 'åœ¨ç°é›¾ä¹‹ä¸Šè·å¾—ä¸‰ä»¶å¥—',
              startTime: 4, duration: 2, layer: 2, color: 'rgb(168, 85, 247)', tags: ['#ä¸‰ä»¶å¥—', '#å”¯ä¸€æ€§', '#ç°é›¾'] },
            { id: 't5', title: 'å‰ä¸–å›å¿†', description: 'å‘¨æ˜ç‘ç©¿è¶Šå‰çš„è®°å¿†ç‰‡æ®µ',
              startTime: -3, duration: 3, layer: 1, color: 'rgb(107, 114, 128)', tags: ['#å›å¿†', '#å‰ä¸–'] }
        ];
        
        let days = [
            { id: 1, name: 'åºç« ç¯‡', startChapter: -5, endChapter: 0 },
            { id: 2, name: 'ç¬¬1å¤©', startChapter: 1, endChapter: 10 },
            { id: 3, name: 'ç¬¬2å¤©', startChapter: 11, endChapter: 20 },
            { id: 4, name: 'ç¬¬3å¤©', startChapter: 21, endChapter: 30 }
        ];
        
        // ç« èŠ‚å·æ ¼å¼åŒ–å‡½æ•°
        function formatChapter(num) {
            if (num < 0) {
                return `åº${-num}`;  // -5 æ˜¾ç¤ºä¸º "åº5"
            } else if (num === 0) {
                return 'åºç« ';
            } else {
                return `ç¬¬${num}ç« `;
            }
        }
        
        // ç« èŠ‚èŒƒå›´æ ¼å¼åŒ–
        function formatChapterRange(start, end) {
            return `${formatChapter(start)}-${formatChapter(end)}`;
        }
        
        // æ£€æŸ¥ç« èŠ‚èŒƒå›´æ˜¯å¦é‡å 
        function checkChapterOverlap(newStart, newEnd, excludeId = null) {
            const newMin = Math.min(newStart, newEnd);
            const newMax = Math.max(newStart, newEnd);
            
            for (let day of days) {
                if (excludeId !== null && day.id === excludeId) continue;
                
                const dayMin = Math.min(day.startChapter, day.endChapter);
                const dayMax = Math.max(day.startChapter, day.endChapter);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é‡å 
                if (!(newMax < dayMin || newMin > dayMax)) {
                    return {
                        overlap: true,
                        conflictDay: day
                    };
                }
            }
            
            return { overlap: false };
        }
        

        // åˆå§‹åŒ–å…¨å±€æ ‡ç­¾åº“
        function initGlobalTags() {
            events.forEach(event => {
                if (event.tags) {
                    event.tags.forEach(tag => globalTagLibrary.add(tag));
                }
            });
        }
        
        function init() {
            initGlobalTags(); // åˆå§‹åŒ–å…¨å±€æ ‡ç­¾åº“
            updateZoom();
            render();
            setupEventListeners();
            
            // ç¡®ä¿æ ‡ç­¾é¢œè‰²åœ¨é¡µé¢åŠ è½½åæ›´æ–°
            setTimeout(() => {
                updateLabelColors();
            }, 500);
        }
        
        function setupEventListeners() {
            document.getElementById('eventTagInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag();
                }
            });
        }
        
        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('editModeBtn');
            const addBtn = document.getElementById('addEventBtn');
            const hint = document.getElementById('timelineHint');
            
            if (editMode) {
                btn.textContent = 'âœ“ ç¼–è¾‘ä¸­';
                btn.className = 'btn btn-success';
                addBtn.style.display = 'block';
                hint.textContent = 'æ‹–åŠ¨äº‹ä»¶å¯æ”¹å˜ä½ç½®å’Œç« èŠ‚ï¼Œæ‹–åŠ¨å³è¾¹ç¼˜å¯è°ƒæ•´æŒç»­ç« èŠ‚æ•°';
            } else {
                btn.textContent = 'âœ ç¼–è¾‘';
                btn.className = 'btn btn-primary';
                addBtn.style.display = 'none';
                hint.textContent = 'ç‚¹å‡»äº‹ä»¶æŸ¥çœ‹è¯¦æƒ…';
            }
            
            render();
        }
        
        function zoomIn() {
            zoom = Math.min(500, zoom + 10);
            updateZoom();
        }
        
        function zoomOut() {
            zoom = Math.max(10, zoom - 10);
            updateZoom();
        }
        
        function setZoom(value) {
            zoom = Math.max(10, Math.min(500, value));
            updateZoom();
        }
        
        function updateZoom() {
            document.getElementById('zoomInput').value = zoom;
            render();
        }
        
        function render() {
            renderTimeline();
        }
        
        // å°†hexé¢œè‰²è½¬æ¢ä¸ºrgbå­—ç¬¦ä¸²
        function hexToRgb(hex) {
            hex = hex.replace('#', '');
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            return { r, g, b };
        }
        
        // å°†hexé¢œè‰²è½¬æ¢ä¸ºæ›´äº®çš„ç‰ˆæœ¬
        function brightenColor(hex, percent = 30) {
            // ç§»é™¤#å·
            hex = hex.replace('#', '');
            
            // è½¬æ¢ä¸ºRGB
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            
            // å¢åŠ äº®åº¦
            const newR = Math.min(255, Math.floor(r + (255 - r) * percent / 100));
            const newG = Math.min(255, Math.floor(g + (255 - g) * percent / 100));
            const newB = Math.min(255, Math.floor(b + (255 - b) * percent / 100));
            
            // è½¬å›hex
            return '#' + 
                newR.toString(16).padStart(2, '0') + 
                newG.toString(16).padStart(2, '0') + 
                newB.toString(16).padStart(2, '0');
        }
        
        // å°†rgbé¢œè‰²è½¬æ¢ä¸ºæ›´äº®çš„ç‰ˆæœ¬
        function brightenRgbColor(rgb, percent = 30) {
            // è§£ærgbå­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ "rgb(30, 27, 75)" æˆ– "rgba(30, 27, 75, 1)"
            const match = rgb.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
            if (!match) return rgb;
            
            const r = parseInt(match[1]);
            const g = parseInt(match[2]);
            const b = parseInt(match[3]);
            
            // å¢åŠ äº®åº¦
            const newR = Math.min(255, Math.floor(r + (255 - r) * percent / 100));
            const newG = Math.min(255, Math.floor(g + (255 - g) * percent / 100));
            const newB = Math.min(255, Math.floor(b + (255 - b) * percent / 100));
            
            return `rgb(${newR}, ${newG}, ${newB})`;
        }
        
        // æ›´æ–°æ ‡ç­¾èƒŒæ™¯è‰²ï¼ˆç‹¬ç«‹å‡½æ•°ï¼‰
        function updateLabelColors() {
            const hiddenArea = document.querySelector('.hidden-layer-area');
            const surfaceArea = document.querySelector('.surface-layer-area');
            const hiddenLabel = document.getElementById('hiddenLabel');
            const surfaceLabel = document.getElementById('surfaceLabel');
            
            if (hiddenArea && hiddenLabel) {
                const bgColor = window.getComputedStyle(hiddenArea).backgroundColor;
                const brightColor = brightenRgbColor(bgColor, 40);
                hiddenLabel.style.background = brightColor;
            }
            
            if (surfaceArea && surfaceLabel) {
                const bgColor = window.getComputedStyle(surfaceArea).backgroundColor;
                const brightColor = brightenRgbColor(bgColor, 40);
                surfaceLabel.style.background = brightColor;
            }
        }
        
        function renderTimeline() {
            const chapterWidth = (zoom / 100) * 50;
            
            // åŠ¨æ€è®¡ç®—æ—¶é—´çº¿èŒƒå›´
            const allChapters = [
                ...days.flatMap(d => [d.startChapter, d.endChapter]),
                ...events.flatMap(e => [e.startTime, e.startTime + e.duration])
            ];
            const minChapter = Math.min(...allChapters, 0);
            const maxChapter = Math.max(...allChapters, 100);
            const timelineWidth = (maxChapter - minChapter) * chapterWidth;
            
            // ä½¿ç”¨ç­›é€‰åçš„äº‹ä»¶è®¡ç®—maxLayer
            const displayEvents = filteredTag 
                ? events.filter(e => e.tags && e.tags.includes(filteredTag))
                : events;
            const maxLayer = Math.max(...displayEvents.map(e => e.layer), 5);
            
            // Render header - æ˜¾ç¤ºå¤©æ•°
            const header = document.getElementById('timelineHeader');
            header.style.minWidth = timelineWidth + 'px';
            header.innerHTML = days.map(day => {
                const dayWidth = Math.abs(day.endChapter - day.startChapter) + 1;
                const leftPos = (Math.min(day.startChapter, day.endChapter) - minChapter) * chapterWidth;
                return `
                <div class="chapter-label" style="
                    position: absolute;
                    left: ${leftPos}px;
                    width: ${dayWidth * chapterWidth}px;
                ">
                    <div>${day.name}</div>
                    <div class="chapter-sublabel">${formatChapterRange(day.startChapter, day.endChapter)}</div>
                </div>
            `;
            }).join('');
            
            // Render events - åˆ†å±‚æ˜¾ç¤º
            const grid = document.getElementById('timelineGrid');
            grid.style.minWidth = timelineWidth + 'px';
            
            // åˆ†ç¦»æš—å±‚å’Œè¡¨å±‚äº‹ä»¶
            const hiddenEvents = displayEvents.filter(e => e.eventLayer === 'hidden');
            const surfaceEvents = displayEvents.filter(e => !e.eventLayer || e.eventLayer === 'surface');
            
            // è®¡ç®—å„å±‚é«˜åº¦
            const maxHiddenLayer = hiddenEvents.length > 0 ? Math.max(...hiddenEvents.map(e => e.layer), 3) : 3;
            const maxSurfaceLayer = surfaceEvents.length > 0 ? Math.max(...surfaceEvents.map(e => e.layer), 3) : 3;
            
            const hiddenAreaHeight = (maxHiddenLayer + 1) * 80 + 60;
            const surfaceAreaHeight = (maxSurfaceLayer + 1) * 80 + 60;
            
            // æ¸²æŸ“å•ä¸ªäº‹ä»¶å—
            const renderEventBlock = (event, isHidden) => {
                const left = (event.startTime - minChapter) * chapterWidth;
                const width = Math.max(event.duration * chapterWidth, 80);
                const top = event.layer * 80 + 45; // ç•™å‡ºæ ‡ç­¾ç©ºé—´ï¼ˆç¼©å°åçš„æ ‡ç­¾ï¼‰
                
                const bgColor = isHidden 
                    ? 'linear-gradient(135deg, #a855f7 0%, #9333ea 100%)'
                    : 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                const borderColor = isHidden ? '3px solid #e9d5ff' : '3px solid #bae6fd';
                // æ”¯æŒè‡ªå®šä¹‰emojiï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤
                const layerIcon = event.emoji || (isHidden ? 'ğŸŒ‘' : 'â˜€ï¸');
                
                return `
                    <div class="event-block ${editMode ? 'editable' : ''}" 
                         data-id="${event.id}"
                         data-min-chapter="${minChapter}"
                         data-layer-type="${isHidden ? 'hidden' : 'surface'}"
                         style="
                            left: ${left}px;
                            width: ${width}px;
                            top: ${top}px;
                            background: ${bgColor};
                            border: ${borderColor};
                         ">
                        <div class="event-title"><span style="font-size: 14px; margin-right: 4px; opacity: 0.8;">${layerIcon}</span>${event.title}</div>
                        <div class="event-time">${formatChapterRange(event.startTime, event.startTime + event.duration)}</div>
                        ${event.tags ? `
                            <div class="event-tags">
                                ${event.tags.slice(0, 2).map(tag => `
                                    <span class="event-tag">${tag}</span>
                                `).join('')}
                            </div>
                        ` : ''}
                        <div class="resize-handle" data-id="${event.id}"></div>
                    </div>
                `;
            };
            
            // è®¾ç½®CSSå˜é‡ï¼ˆç”¨äºæ ¼å­èƒŒæ™¯ï¼‰
            grid.style.setProperty('--chapter-width', chapterWidth + 'px');
            grid.style.setProperty('--day-width', (chapterWidth / 5) + 'px');
            
            // æ„å»ºåˆ†å±‚HTML
            grid.innerHTML = `
                <!-- æš—å±‚åŒºåŸŸ -->
                <div class="hidden-layer-area" style="min-width: ${timelineWidth}px; height: ${hiddenAreaHeight}px;">
                    <div class="layer-label hidden-layer-label" id="hiddenLabel">ğŸŒ‘ æš—å±‚ï¼ˆå¹•åå¸ƒå±€ï¼‰</div>
                    ${hiddenEvents.map(e => renderEventBlock(e, true)).join('')}
                </div>
                
                <!-- åˆ†éš”çº¿ï¼ˆä¸‰å±‚åˆ»åº¦ï¼‰-->
                <div class="layer-divider" style="min-width: ${timelineWidth}px;">
                    <!-- ä¸Šå±‚ï¼šç« èŠ‚åˆ»åº¦ -->
                    <div class="top-scale">
                        ${(() => {
                            let markers = '';
                            // æ ¹æ®ç¼©æ”¾æ¯”ä¾‹æ™ºèƒ½æ˜¾ç¤ºé—´éš”
                            let step = 1;
                            if (zoom < 30) step = 10;
                            else if (zoom < 50) step = 5;
                            else if (zoom < 80) step = 2;
                            
                            for (let chapter = minChapter; chapter <= maxChapter; chapter++) {
                                if ((chapter - minChapter) % step === 0 || chapter === minChapter || chapter === maxChapter) {
                                    const left = (chapter - minChapter) * chapterWidth;
                                    markers += `<div class="chapter-marker" style="left: ${left}px;">${formatChapter(chapter)}</div>`;
                                }
                            }
                            return markers;
                        })()}
                    </div>
                    
                    <!-- ä¸­å±‚ï¼šå¤©æ•°åˆ»åº¦ï¼ˆç”¨æˆ·è®¾å®šçš„å¤©æ•°ï¼‰-->
                    <div class="middle-scale">
                        ${(() => {
                            let markers = '';
                            // ä½¿ç”¨ç”¨æˆ·è®¾å®šçš„å¤©æ•°
                            days.forEach(day => {
                                // åªæ˜¾ç¤ºåœ¨å½“å‰è§†å›¾èŒƒå›´å†…çš„å¤©æ•°
                                if (day.startChapter >= minChapter && day.startChapter <= maxChapter) {
                                    const left = (day.startChapter - minChapter) * chapterWidth;
                                    markers += `<div class="day-marker" style="left: ${left}px;">${day.name}</div>`;
                                }
                            });
                            return markers;
                        })()}
                    </div>
                    
                    <!-- ä¸‹å±‚ï¼šç« èŠ‚åˆ»åº¦ -->
                    <div class="bottom-scale">
                        ${(() => {
                            let markers = '';
                            // æ ¹æ®ç¼©æ”¾æ¯”ä¾‹æ™ºèƒ½æ˜¾ç¤ºé—´éš”
                            let step = 1;
                            if (zoom < 30) step = 10;
                            else if (zoom < 50) step = 5;
                            else if (zoom < 80) step = 2;
                            
                            for (let chapter = minChapter; chapter <= maxChapter; chapter++) {
                                if ((chapter - minChapter) % step === 0 || chapter === minChapter || chapter === maxChapter) {
                                    const left = (chapter - minChapter) * chapterWidth;
                                    markers += `<div class="chapter-marker" style="left: ${left}px;">${formatChapter(chapter)}</div>`;
                                }
                            }
                            return markers;
                        })()}
                    </div>
                    
                    <!-- å·²ç§»é™¤æš—å±‚/è¡¨å±‚æ ‡ç­¾ï¼Œé¿å…æŒ¡è·¯ -->
                </div>
                
                <!-- è¡¨å±‚åŒºåŸŸ -->
                <div class="surface-layer-area" style="min-width: ${timelineWidth}px; height: ${surfaceAreaHeight}px;">
                    <div class="layer-label surface-layer-label" id="surfaceLabel">â˜€ï¸ è¡¨å±‚ï¼ˆæ—¥å¸¸äº‹ä»¶ï¼‰</div>
                    ${surfaceEvents.map(e => renderEventBlock(e, false)).join('')}
                </div>
            `;
            
            // Update scale
            document.getElementById('scaleStart').textContent = formatChapter(minChapter);
            document.getElementById('scaleEnd').textContent = formatChapter(maxChapter);
            
            // Add drag event listeners
            document.querySelectorAll('.event-block').forEach(block => {
                block.addEventListener('mousedown', (e) => {
                    if (!e.target.classList.contains('resize-handle')) {
                        startDrag(e);
                    }
                });
                block.addEventListener('touchstart', (e) => {
                    if (!e.target.classList.contains('resize-handle')) {
                        startDrag(e);
                    }
                }, { passive: false });
                block.addEventListener('click', (e) => {
                    if (!hasDragged && !e.target.classList.contains('resize-handle')) {
                        showEventDetail(block.dataset.id);
                    }
                    hasDragged = false;
                });
            });
            
            // Add resize event listeners
            document.querySelectorAll('.resize-handle').forEach(handle => {
                handle.addEventListener('mousedown', (e) => startResize(e));
                handle.addEventListener('touchstart', (e) => startResize(e), { passive: false });
            });
            
            // æ›´æ–°æ ‡ç­¾èƒŒæ™¯è‰²
            setTimeout(() => {
                updateLabelColors();
            }, 200);
        }
        
        function startDrag(e) {
            if (!editMode) return;
            e.preventDefault();
            
            const block = e.currentTarget;
            const id = block.dataset.id;
            const event = events.find(ev => ev.id === id);
            if (!event) return;
            
            hasDragged = false;
            draggingEvent = event;
            originalLayer = event.layer; // è®°å½•åŸå§‹å±‚
            
            // è®°å½•åˆå§‹äº‹ä»¶ä½ç½®
            initialEventPos = {
                startTime: event.startTime,
                layer: event.layer
            };
            
            const rect = block.getBoundingClientRect();
            const canvas = document.getElementById('timelineCanvas');
            const canvasRect = canvas.getBoundingClientRect();
            
            // æ”¯æŒè§¦æ‘¸å’Œé¼ æ ‡äº‹ä»¶
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            // è®°å½•åˆå§‹é¼ æ ‡ä½ç½®ï¼ˆç›¸å¯¹äºcanvasï¼‰
            initialMousePos = {
                x: clientX - canvasRect.left + canvas.scrollLeft,
                y: clientY - canvasRect.top + canvas.scrollTop
            };
            
            dragOffset = {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
            
            block.classList.add('dragging');
            
            // æ·»åŠ é¼ æ ‡å’Œè§¦æ‘¸äº‹ä»¶
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', onDrag, { passive: false });
            document.addEventListener('touchend', endDrag);
        }
        
        function onDrag(e) {
            if (!draggingEvent) return;
            e.preventDefault();
            
            hasDragged = true;
            
            // æ”¯æŒè§¦æ‘¸å’Œé¼ æ ‡äº‹ä»¶
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const canvas = document.getElementById('timelineCanvas');
            const canvasRect = canvas.getBoundingClientRect();
            const chapterWidth = (zoom / 100) * 50;
            
            // ===== ç®€å•è‡ªåŠ¨æ»šåŠ¨ï¼ˆä¸å½±å“ä»»ä½•å…¶ä»–é€»è¾‘ï¼‰=====
            const edgeZone = 100;
            const scrollStep = 8;
            
            // ä½¿ç”¨windowåæ ‡æ£€æµ‹
            if (clientY < edgeZone && canvas.scrollTop > 0) {
                // é è¿‘å±å¹•é¡¶éƒ¨ï¼Œå‘ä¸Šæ»š
                canvas.scrollTop -= scrollStep;
            } else if (clientY > window.innerHeight - edgeZone) {
                // é è¿‘å±å¹•åº•éƒ¨ï¼Œå‘ä¸‹æ»š
                const maxScroll = canvas.scrollHeight - canvas.clientHeight;
                if (canvas.scrollTop < maxScroll) {
                    canvas.scrollTop += scrollStep;
                }
            }
            // ===== è‡ªåŠ¨æ»šåŠ¨ç»“æŸ =====
            
            const block = document.querySelector(`[data-id="${draggingEvent.id}"]`);
            if (!block) return;
            
            const minChapter = parseInt(block.dataset.minChapter || 0);
            
            // è®¡ç®—æ¨ªå‘ç§»åŠ¨
            const currentMouseX = clientX - canvasRect.left + canvas.scrollLeft;
            const deltaX = currentMouseX - initialMousePos.x;
            const deltaChapters = Math.round(deltaX / chapterWidth);
            const newStartTime = initialEventPos.startTime + deltaChapters;
            
            // æ£€æµ‹åœ¨å“ªä¸ªåŒºåŸŸ
            const divider = document.querySelector('.layer-divider');
            if (divider) {
                const dividerRect = divider.getBoundingClientRect();
                
                let targetLayer = draggingEvent.eventLayer || 'surface';
                
                if (clientY < dividerRect.top) {
                    targetLayer = 'hidden';
                } else if (clientY > dividerRect.bottom) {
                    targetLayer = 'surface';
                }
                
                // å¦‚æœå±‚çº§æ”¹å˜ï¼Œé‡æ–°æ¸²æŸ“
                if (targetLayer !== draggingEvent.eventLayer) {
                    draggingEvent.eventLayer = targetLayer;
                    draggingEvent.layer = 0;
                    draggingEvent.startTime = newStartTime;
                    render();
                    return;
                }
            }
            
            // åœ¨å½“å‰å±‚å†…ç§»åŠ¨
            const hiddenArea = document.querySelector('.hidden-layer-area');
            const surfaceArea = document.querySelector('.surface-layer-area');
            
            if (draggingEvent.eventLayer === 'hidden' && hiddenArea) {
                const rect = hiddenArea.getBoundingClientRect();
                const relativeY = clientY - rect.top;
                const newLayer = Math.max(0, Math.floor((relativeY - 50) / 80));
                
                draggingEvent.startTime = newStartTime;
                draggingEvent.layer = newLayer;
                block.style.left = ((newStartTime - minChapter) * chapterWidth) + 'px';
                block.style.top = (newLayer * 80 + 50) + 'px';
            } else if (surfaceArea) {
                const rect = surfaceArea.getBoundingClientRect();
                const relativeY = clientY - rect.top;
                const newLayer = Math.max(0, Math.floor((relativeY - 50) / 80));
                
                draggingEvent.startTime = newStartTime;
                draggingEvent.layer = newLayer;
                block.style.left = ((newStartTime - minChapter) * chapterWidth) + 'px';
                block.style.top = (newLayer * 80 + 50) + 'px';
            }
        }
        

        // äº¤æ¢ä¸¤ä¸ªå±‚çš„äº‹ä»¶
        function swapLayers(targetLayer, sourceLayer, movingEvent) {
            console.log(`äº¤æ¢å±‚ ${sourceLayer} å’Œ ${targetLayer}`);
            
            const movingEventEnd = movingEvent.startTime + movingEvent.duration;
            
            // æ‰¾åˆ°ç›®æ ‡å±‚ä¸­ä¸æ‹–åŠ¨äº‹ä»¶æ—¶é—´é‡å çš„æ‰€æœ‰äº‹ä»¶
            const overlappingEvents = events.filter(e => {
                if (e.layer !== targetLayer || e.id === movingEvent.id) return false;
                
                const eventEnd = e.startTime + e.duration;
                // æ£€æŸ¥æ—¶é—´æ˜¯å¦é‡å 
                const timeOverlap = !(movingEventEnd <= e.startTime || movingEvent.startTime >= eventEnd);
                return timeOverlap;
            });
            
            console.log(`ç›®æ ‡å±‚ ${targetLayer} æœ‰ ${overlappingEvents.length} ä¸ªé‡å äº‹ä»¶`);
            
            if (overlappingEvents.length === 0) {
                console.log('æ²¡æœ‰é‡å äº‹ä»¶ï¼Œä¸éœ€è¦äº¤æ¢');
                return;
            }
            
            // å°†é‡å çš„äº‹ä»¶ç§»åŠ¨åˆ°æºå±‚
            overlappingEvents.forEach(event => {
                event.layer = sourceLayer;
                console.log(`âœ… äº¤æ¢: "${event.title}" ä»å±‚ ${targetLayer} ç§»åˆ°å±‚ ${sourceLayer}`);
            });
            
            // æ£€æŸ¥äº¤æ¢åæ˜¯å¦æœ‰ç¢°æ’ï¼Œå¦‚æœæœ‰å°±è‡ªåŠ¨è°ƒæ•´å±‚
            overlappingEvents.forEach(event => {
                const collision = checkCollision(event);
                if (collision) {
                    const freeLayer = findFreeLayer(event.startTime, event.duration, event.id);
                    console.log(`âš ï¸ "${event.title}" åœ¨å±‚ ${event.layer} æœ‰ç¢°æ’ï¼Œç§»åˆ°å±‚ ${freeLayer}`);
                    event.layer = freeLayer;
                }
            });
            
            console.log(`âœ… "${movingEvent.title}" ç°åœ¨åœ¨å±‚ ${targetLayer}`);
        }
        
        function endDrag(e) {
            if (!draggingEvent) return;
            
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', onDrag);
            document.removeEventListener('touchend', endDrag);
            
            const newLayer = draggingEvent.layer;
            
            // æ£€æŸ¥æ˜¯å¦æ¢å±‚äº†
            if (originalLayer !== null && newLayer !== originalLayer) {
                console.log(`æ£€æµ‹åˆ°æ¢å±‚ï¼šä» ${originalLayer} åˆ° ${newLayer}`);
                
                // æ£€æŸ¥ç›®æ ‡å±‚æ˜¯å¦æœ‰äº‹ä»¶
                const targetLayerHasEvents = events.some(e => 
                    e.layer === newLayer && e.id !== draggingEvent.id
                );
                
                if (targetLayerHasEvents) {
                    // æ‰§è¡Œäº¤æ¢
                    swapLayers(newLayer, originalLayer, draggingEvent);
                }
            } else {
                // æ²¡æœ‰æ¢å±‚ï¼Œæ£€æŸ¥ç¢°æ’
                const collision = checkCollision(draggingEvent);
                if (collision) {
                    const freeLayer = findFreeLayer(draggingEvent.startTime, draggingEvent.duration, draggingEvent.id);
                    draggingEvent.layer = freeLayer;
                }
            }
            
            const block = document.querySelector(`[data-id="${draggingEvent.id}"]`);
            if (block) {
                block.classList.remove('dragging');
            }
            
            originalLayer = null; // é‡ç½®
            draggingEvent = null;
            render();
        }
        
        function checkCollision(event) {
            const eventEnd = event.startTime + event.duration;
            
            for (let other of events) {
                if (other.id === event.id) continue;
                
                const otherEnd = other.startTime + other.duration;
                const timeOverlap = !(eventEnd <= other.startTime || event.startTime >= otherEnd);
                const layerOverlap = event.layer === other.layer;
                
                if (timeOverlap && layerOverlap) {
                    return other;
                }
            }
            
            return null;
        }
        
        function findFreeLayer(startTime, duration, excludeId) {
            const eventEnd = startTime + duration;
            
            for (let layer = 0; layer < 20; layer++) {
                let isFree = true;
                
                for (let other of events) {
                    if (other.id === excludeId) continue;
                    if (other.layer !== layer) continue;
                    
                    const otherEnd = other.startTime + other.duration;
                    const timeOverlap = !(eventEnd <= other.startTime || startTime >= otherEnd);
                    
                    if (timeOverlap) {
                        isFree = false;
                        break;
                    }
                }
                
                if (isFree) {
                    return layer;
                }
            }
            
            return 0;
        }
        
        function startResize(e) {
            if (!editMode) return;
            e.preventDefault();
            e.stopPropagation();
            
            const handle = e.target;
            const id = handle.dataset.id;
            const event = events.find(ev => ev.id === id);
            if (!event) return;
            
            resizingEvent = event;
            
            document.addEventListener('mousemove', onResize);
            document.addEventListener('mouseup', endResize);
            document.addEventListener('touchmove', onResize, { passive: false });
            document.addEventListener('touchend', endResize);
        }
        
        function onResize(e) {
            if (!resizingEvent) return;
            e.preventDefault();
            
            const canvas = document.getElementById('timelineCanvas');
            const canvasRect = canvas.getBoundingClientRect();
            const dayWidth = (zoom / 100) * 50;
            
            const block = document.querySelector(`[data-id="${resizingEvent.id}"]`);
            if (!block) return;
            
            const blockRect = block.getBoundingClientRect();
            const blockLeft = blockRect.left - canvasRect.left + canvas.scrollLeft;
            
            // æ”¯æŒè§¦æ‘¸å’Œé¼ æ ‡äº‹ä»¶
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const mouseX = clientX - canvasRect.left + canvas.scrollLeft;
            const newWidth = mouseX - blockLeft;
            const newDuration = Math.max(1, Math.round(newWidth / dayWidth));
            
            resizingEvent.duration = newDuration;
            block.style.width = Math.max(newDuration * dayWidth, 80) + 'px';
            
            const timeDisplay = block.querySelector('.event-time');
            if (timeDisplay) {
                timeDisplay.textContent = `ç¬¬${resizingEvent.startTime}-${resizingEvent.startTime + resizingEvent.duration}å¤©`;
            }
        }
        
        function endResize(e) {
            if (!resizingEvent) return;
            
            document.removeEventListener('mousemove', onResize);
            document.removeEventListener('mouseup', endResize);
            document.removeEventListener('touchmove', onResize);
            document.removeEventListener('touchend', endResize);
            
            resizingEvent = null;
            render();
        }
        
        function showEventDetail(id) {
            const event = events.find(e => e.id === id);
            if (!event) return;
            
            selectedEvent = event;
            const modal = document.getElementById('eventDetailModal');
            
            const day = days.find(d => {
                const min = Math.min(d.startChapter, d.endChapter);
                const max = Math.max(d.startChapter, d.endChapter);
                return event.startTime >= min && event.startTime <= max;
            });
            const dayName = day ? day.name : 'æœªåˆ†é…';
            
            document.getElementById('eventDetailTitle').textContent = event.title;
            // è·å–å› æœé“¾ä¿¡æ¯
            const causeEvents = (event.causes || []).map(id => events.find(e => e.id === id)).filter(Boolean);
            const effectEvents = (event.effects || []).map(id => events.find(e => e.id === id)).filter(Boolean);
            
            document.getElementById('eventDetailBody').innerHTML = `
                <div class="info-box">
                    <h3>ğŸ“ æè¿°</h3>
                    <p>${event.description}</p>
                </div>
                <div class="info-box">
                    <h3>â±ï¸ æ—¶é—´ä¿¡æ¯</h3>
                    <p><strong>æ‰€å±å¤©æ•°ï¼š</strong>${dayName}</p>
                    <p><strong>èµ·å§‹ï¼š</strong>${formatChapter(event.startTime)}</p>
                    <p><strong>æŒç»­ï¼š</strong>${event.duration}ç« </p>
                    <p><strong>ç»“æŸï¼š</strong>${formatChapter(event.startTime + event.duration)}</p>
                    <p><strong>æ‰€åœ¨è¡Œä½ç½®ï¼š</strong>ç¬¬${event.layer}è¡Œ</p>
                </div>
                ${event.tags && event.tags.length > 0 ? `
                    <div class="info-box">
                        <h3>ğŸ·ï¸ æ ‡ç­¾</h3>
                        <div class="tag-list">
                            ${event.tags.map(tag => `<span class="tag-item">${tag}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
                ${causeEvents.length > 0 || effectEvents.length > 0 ? `
                    <div class="info-box" style="border-left: 4px solid #8b5cf6;">
                        <h3>ğŸ”— å› æœå…³è”</h3>
                        ${causeEvents.length > 0 ? `
                            <div style="margin-bottom: 12px;">
                                <p style="font-weight: bold; color: #d97706; margin-bottom: 8px;">â¬…ï¸ èµ·å› ï¼š</p>
                                ${causeEvents.map(cause => `
                                    <div style="background: #fef3c7; padding: 8px 12px; border-radius: 6px; margin-bottom: 6px; cursor: pointer;" onclick="showEventDetail('${cause.id}')">
                                        <strong>${cause.title}</strong>
                                        <span style="color: #78350f; font-size: 12px; margin-left: 8px;">${formatChapter(cause.startTime)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${effectEvents.length > 0 ? `
                            <div>
                                <p style="font-weight: bold; color: #2563eb; margin-bottom: 8px;">â¡ï¸ ç»“æœï¼š</p>
                                ${effectEvents.map(effect => `
                                    <div style="background: #dbeafe; padding: 8px 12px; border-radius: 6px; margin-bottom: 6px; cursor: pointer;" onclick="showEventDetail('${effect.id}')">
                                        <strong>${effect.title}</strong>
                                        <span style="color: #1e40af; font-size: 12px; margin-left: 8px;">${formatChapter(effect.startTime)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        <button class="btn btn-sm" onclick="showCausalChain('${event.id}')" style="margin-top: 12px; width: 100%;">
                            ğŸ” æŸ¥çœ‹å®Œæ•´å› æœé“¾
                        </button>
                    </div>
                ` : ''}
            `;
            
            const deleteBtn = document.getElementById('deleteEventBtn');
            if (deleteBtn) {
                deleteBtn.style.display = editMode ? 'block' : 'none';
            }
            
            modal.classList.add('show');
        }
        

        // æ˜¾ç¤ºå› æœé“¾
        function showCausalChain(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;
            
            // é€’å½’è·å–æ‰€æœ‰èµ·å› ï¼ˆå‘ä¸Šè¿½æº¯ï¼‰
            const allCauses = new Set();
            function getCauses(id, depth = 0) {
                if (depth > 10) return; // é˜²æ­¢æ— é™å¾ªç¯
                const e = events.find(ev => ev.id === id);
                if (!e || !e.causes) return;
                
                e.causes.forEach(causeId => {
                    if (!allCauses.has(causeId)) {
                        allCauses.add(causeId);
                        getCauses(causeId, depth + 1);
                    }
                });
            }
            getCauses(eventId);
            
            // é€’å½’è·å–æ‰€æœ‰ç»“æœï¼ˆå‘ä¸‹è¿½æº¯ï¼‰
            const allEffects = new Set();
            function getEffects(id, depth = 0) {
                if (depth > 10) return; // é˜²æ­¢æ— é™å¾ªç¯
                const e = events.find(ev => ev.id === id);
                if (!e || !e.effects) return;
                
                e.effects.forEach(effectId => {
                    if (!allEffects.has(effectId)) {
                        allEffects.add(effectId);
                        getEffects(effectId, depth + 1);
                    }
                });
            }
            getEffects(eventId);
            
            // æ„å»ºå±‚çº§ç»“æ„
            const causesList = Array.from(allCauses).map(id => events.find(e => e.id === id)).filter(Boolean);
            const effectsList = Array.from(allEffects).map(id => events.find(e => e.id === id)).filter(Boolean);
            
            // æŒ‰æ—¶é—´æ’åº
            causesList.sort((a, b) => a.startTime - b.startTime);
            effectsList.sort((a, b) => a.startTime - b.startTime);
            
            // æ¸²æŸ“å› æœé“¾
            document.getElementById('causalChainBody').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="color: #6b7280; margin-bottom: 8px;">å› æœé“¾åˆ†æ</h3>
                    <p style="color: #9ca3af; font-size: 14px;">å…± ${causesList.length} ä¸ªèµ·å›  â†’ <strong style="color: #8b5cf6;">${event.title}</strong> â†’ ${effectsList.length} ä¸ªç»“æœ</p>
                </div>
                
                ${causesList.length > 0 ? `
                    <div style="margin-bottom: 30px;">
                        <div style="background: #fbbf24; color: white; padding: 10px 16px; border-radius: 8px 8px 0 0; font-weight: bold;">
                            â¬…ï¸ èµ·å› é“¾ï¼ˆ${causesList.length}ä¸ªäº‹ä»¶ï¼‰
                        </div>
                        <div style="border: 2px solid #fbbf24; border-top: none; border-radius: 0 0 8px 8px; padding: 16px;">
                            ${causesList.map(cause => `
                                <div style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;"
                                     onmouseover="this.style.background='#fde68a'"
                                     onmouseout="this.style.background='#fef3c7'"
                                     onclick="showEventDetail('${cause.id}'); closeCausalChain();">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <strong style="color: #78350f;">${cause.title}</strong>
                                        <span style="color: #92400e; font-size: 12px;">${formatChapter(cause.startTime)}</span>
                                    </div>
                                    ${cause.description ? `<p style="color: #a16207; font-size: 13px; margin-top: 6px; margin-bottom: 0;">${cause.description}</p>` : ''}
                                    ${cause.effects && cause.effects.length > 0 ? `
                                        <div style="margin-top: 8px; font-size: 12px; color: #92400e;">
                                            â†’ å¯¼è‡´: ${cause.effects.map(id => {
                                                const e = events.find(ev => ev.id === id);
                                                return e ? e.title : '';
                                            }).filter(Boolean).join(', ')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div style="margin: 30px 0; text-align: center;">
                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                        <h3 style="margin: 0 0 8px 0; font-size: 18px;">ğŸ“ å½“å‰äº‹ä»¶</h3>
                        <p style="margin: 0; font-size: 20px; font-weight: bold;">${event.title}</p>
                        <p style="margin: 8px 0 0 0; font-size: 14px; opacity: 0.9;">${formatChapter(event.startTime)} Â· ${event.duration}ç« </p>
                        ${event.description ? `<p style="margin: 12px 0 0 0; font-size: 14px; opacity: 0.95; font-style: italic;">"${event.description}"</p>` : ''}
                    </div>
                </div>
                
                ${effectsList.length > 0 ? `
                    <div style="margin-top: 30px;">
                        <div style="background: #3b82f6; color: white; padding: 10px 16px; border-radius: 8px 8px 0 0; font-weight: bold;">
                            â¡ï¸ ç»“æœé“¾ï¼ˆ${effectsList.length}ä¸ªäº‹ä»¶ï¼‰
                        </div>
                        <div style="border: 2px solid #3b82f6; border-top: none; border-radius: 0 0 8px 8px; padding: 16px;">
                            ${effectsList.map(effect => `
                                <div style="background: #dbeafe; padding: 12px; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;"
                                     onmouseover="this.style.background='#bfdbfe'"
                                     onmouseout="this.style.background='#dbeafe'"
                                     onclick="showEventDetail('${effect.id}'); closeCausalChain();">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <strong style="color: #1e40af;">${effect.title}</strong>
                                        <span style="color: #1e3a8a; font-size: 12px;">${formatChapter(effect.startTime)}</span>
                                    </div>
                                    ${effect.description ? `<p style="color: #1e40af; font-size: 13px; margin-top: 6px; margin-bottom: 0;">${effect.description}</p>` : ''}
                                    ${effect.causes && effect.causes.length > 0 ? `
                                        <div style="margin-top: 8px; font-size: 12px; color: #1e3a8a;">
                                            â† èµ·å› : ${effect.causes.map(id => {
                                                const e = events.find(ev => ev.id === id);
                                                return e ? e.title : '';
                                            }).filter(Boolean).join(', ')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${causesList.length === 0 && effectsList.length === 0 ? `
                    <div style="text-align: center; padding: 40px; color: #9ca3af;">
                        <p style="font-size: 16px;">æ­¤äº‹ä»¶æš‚æ— å› æœå…³è”</p>
                        <p style="font-size: 14px; margin-top: 8px;">ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®å¯ä»¥æ·»åŠ èµ·å› å’Œç»“æœ</p>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('causalChainModal').classList.add('show');
        }
        
        function closeCausalChain() {
            document.getElementById('causalChainModal').classList.remove('show');
        }
        
        function closeEventDetail() {
            document.getElementById('eventDetailModal').classList.remove('show');
            selectedEvent = null;
        }
        
        function showAddEventForm() {
            editingEvent = null;
            currentTags = [];
            currentCauses = [];
            currentEffects = [];
            document.getElementById('eventFormTitle').textContent = 'â• æ·»åŠ äº‹ä»¶';
            document.getElementById('eventForm').reset();
            document.getElementById('eventTagsList').innerHTML = '';
            renderCausesList();
            renderEffectsList();
            renderRelationSelects(null);
            document.getElementById('eventFormModal').classList.add('show');
            updateDayHint();
        }
        
        function editEvent() {
            if (!selectedEvent) return;
            editingEvent = selectedEvent;
            currentTags = [...(selectedEvent.tags || [])];
            currentCauses = [...(selectedEvent.causes || [])];
            currentEffects = [...(selectedEvent.effects || [])];
            
            document.getElementById('eventFormTitle').textContent = 'âœï¸ ç¼–è¾‘äº‹ä»¶';
            document.getElementById('eventTitle').value = selectedEvent.title;
            document.getElementById('eventDescription').value = selectedEvent.description;
            document.getElementById('eventEmoji').value = selectedEvent.emoji || '';
            document.getElementById('eventStartTime').value = selectedEvent.startTime;
            document.getElementById('eventDuration').value = selectedEvent.duration;
            document.getElementById('eventLayer').value = selectedEvent.layer;
            

            renderTagsList();
            renderAvailableTags(); // æ¸²æŸ“å¯é€‰æ ‡ç­¾
            renderCausesList();
            renderEffectsList();
            renderRelationSelects(selectedEvent.id);
            closeEventDetail();
            document.getElementById('eventFormModal').classList.add('show');
            updateDayHint();
        }
        
        function closeEventForm() {
            document.getElementById('eventFormModal').classList.remove('show');
            editingEvent = null;
            currentTags = [];
            currentCauses = [];
            currentEffects = [];
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventEmoji').value = '';
        }
        
        function addTag() {
            const input = document.getElementById('eventTagInput');
            const tag = input.value.trim();
            if (!tag) return;
            
            const formattedTag = tag.startsWith('#') ? tag : '#' + tag;
            if (!currentTags.includes(formattedTag)) {
                currentTags.push(formattedTag);
                renderTagsList();
            }
            input.value = '';
        }
        
        function removeTag(tag) {
            currentTags = currentTags.filter(t => t !== tag);
            renderTagsList();
        }
        


        // æ¸²æŸ“èµ·å› åˆ—è¡¨
        function renderCausesList() {
            const container = document.getElementById('causesList');
            if (!container) return;
            
            if (currentCauses.length === 0) {
                container.innerHTML = '<span style="color: #9ca3af; font-size: 13px; font-style: italic;">æš‚æ— èµ·å› </span>';
                return;
            }
            
            container.innerHTML = currentCauses.map(causeId => {
                const causeEvent = events.find(e => e.id === causeId);
                if (!causeEvent) return '';
                return `
                    <span style="background: #fbbf24; color: #78350f; padding: 4px 10px; border-radius: 6px; font-size: 13px; display: inline-flex; align-items: center; gap: 6px;">
                        ${causeEvent.title}
                        <button type="button" onclick="removeCause('${causeId}')" style="background: none; border: none; color: #78350f; cursor: pointer; padding: 0; font-weight: bold;">Ã—</button>
                    </span>
                `;
            }).filter(Boolean).join('');
        }
        
        // æ¸²æŸ“ç»“æœåˆ—è¡¨
        function renderEffectsList() {
            const container = document.getElementById('effectsList');
            if (!container) return;
            
            if (currentEffects.length === 0) {
                container.innerHTML = '<span style="color: #9ca3af; font-size: 13px; font-style: italic;">æš‚æ— ç»“æœ</span>';
                return;
            }
            
            container.innerHTML = currentEffects.map(effectId => {
                const effectEvent = events.find(e => e.id === effectId);
                if (!effectEvent) return '';
                return `
                    <span style="background: #3b82f6; color: #eff6ff; padding: 4px 10px; border-radius: 6px; font-size: 13px; display: inline-flex; align-items: center; gap: 6px;">
                        ${effectEvent.title}
                        <button type="button" onclick="removeEffect('${effectId}')" style="background: none; border: none; color: #eff6ff; cursor: pointer; padding: 0; font-weight: bold;">Ã—</button>
                    </span>
                `;
            }).filter(Boolean).join('');
        }
        
        // æ¸²æŸ“å¯é€‰äº‹ä»¶ä¸‹æ‹‰æ¡†
        function renderRelationSelects(currentEventId) {
            const causeSelect = document.getElementById('causeSelect');
            const effectSelect = document.getElementById('effectSelect');
            
            if (!causeSelect || !effectSelect) return;
            
            // è·å–å¯é€‰çš„äº‹ä»¶ï¼ˆæ’é™¤å½“å‰äº‹ä»¶å’Œå·²é€‰çš„ï¼‰
            const availableEvents = events.filter(e => e.id !== currentEventId);
            
            // æ¸²æŸ“èµ·å› ä¸‹æ‹‰æ¡†
            causeSelect.innerHTML = '<option value="">+ æ·»åŠ èµ·å› äº‹ä»¶</option>' + 
                availableEvents
                    .filter(e => !currentCauses.includes(e.id))
                    .map(e => `<option value="${e.id}">${e.title}</option>`)
                    .join('');
            
            // æ¸²æŸ“ç»“æœä¸‹æ‹‰æ¡†
            effectSelect.innerHTML = '<option value="">+ æ·»åŠ ç»“æœäº‹ä»¶</option>' + 
                availableEvents
                    .filter(e => !currentEffects.includes(e.id))
                    .map(e => `<option value="${e.id}">${e.title}</option>`)
                    .join('');
        }
        
        // æ·»åŠ èµ·å› 
        function addCause() {
            const select = document.getElementById('causeSelect');
            const causeId = select.value;
            
            if (!causeId) return;
            
            if (!currentCauses.includes(causeId)) {
                currentCauses.push(causeId);
                renderCausesList();
                renderRelationSelects(editingEvent?.id);
            }
            
            select.value = '';
        }
        
        // åˆ é™¤èµ·å› 
        function removeCause(causeId) {
            currentCauses = currentCauses.filter(id => id !== causeId);
            renderCausesList();
            renderRelationSelects(editingEvent?.id);
        }
        
        // æ·»åŠ ç»“æœ
        function addEffect() {
            const select = document.getElementById('effectSelect');
            const effectId = select.value;
            
            if (!effectId) return;
            
            if (!currentEffects.includes(effectId)) {
                currentEffects.push(effectId);
                renderEffectsList();
                renderRelationSelects(editingEvent?.id);
            }
            
            select.value = '';
        }
        
        // åˆ é™¤ç»“æœ
        function removeEffect(effectId) {
            currentEffects = currentEffects.filter(id => id !== effectId);
            renderEffectsList();
            renderRelationSelects(editingEvent?.id);
        }
        
        // æ¸²æŸ“å¯é€‰æ ‡ç­¾åˆ—è¡¨
        function renderAvailableTags() {
            const container = document.getElementById('availableTagsList');
            if (!container) return;
            
            // è·å–æ‰€æœ‰å¯ç”¨æ ‡ç­¾
            const allTags = Array.from(globalTagLibrary).sort();
            
            // è·å–å½“å‰å·²æ·»åŠ çš„æ ‡ç­¾
            const addedTags = new Set(currentTags);
            
            // è¿‡æ»¤å‡ºæœªæ·»åŠ çš„æ ‡ç­¾
            const availableTags = allTags.filter(tag => !addedTags.has(tag));
            
            if (availableTags.length === 0) {
                container.innerHTML = '<span style="color: #9ca3af; font-size: 13px; font-style: italic;">æš‚æ— å¯é€‰æ ‡ç­¾</span>';
                return;
            }
            
            container.innerHTML = availableTags.map(tag => `
                <button type="button" 
                        class="btn btn-sm" 
                        onclick="quickAddTag('${tag.replace(/'/g, "\\'")}')"
                        style="background: white; border: 1px solid #d1d5db; color: #374151; padding: 4px 12px; font-size: 13px; cursor: pointer; transition: all 0.2s;"
                        onmouseover="this.style.background='#e5e7eb'; this.style.borderColor='#9ca3af';"
                        onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
                    ${tag}
                </button>
            `).join('');
        }
        
        // å¿«é€Ÿæ·»åŠ æ ‡ç­¾
        function quickAddTag(tag) {
            if (!currentTags.includes(tag)) {
                currentTags.push(tag);
                renderTagsList();
                renderAvailableTags(); // åˆ·æ–°å¯é€‰æ ‡ç­¾åˆ—è¡¨
            }
        }
        
        function renderTagsList() {
            const container = document.getElementById('eventTagsList');
            container.innerHTML = currentTags.map(tag => `
                <span class="tag-item">
                    ${tag}
                    <button class="tag-remove" onclick="removeTag('${tag}')">Ã—</button>
                </span>
            `).join('');
        }
        
        function saveEvent() {
            const title = document.getElementById('eventTitle').value.trim();
            const description = document.getElementById('eventDescription').value.trim();
            const emoji = document.getElementById('eventEmoji').value.trim();
            const startTime = parseInt(document.getElementById('eventStartTime').value);
            const duration = parseInt(document.getElementById('eventDuration').value) || 1;
            const layer = parseInt(document.getElementById('eventLayer').value) || 0;
            
            if (!title) {
                alert('è¯·è¾“å…¥äº‹ä»¶æ ‡é¢˜');
                return;
            }
            
            if (isNaN(startTime)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„èµ·å§‹ç« èŠ‚');
                return;
            }
            
            const eventData = {
                title,
                description,
                emoji: emoji || '', // ä¿å­˜emojiï¼Œä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤
                startTime,
                duration,
                layer,
                color: 'rgb(59, 130, 246)', // é»˜è®¤è“è‰²
                tags: currentTags,
                causes: currentCauses,
                effects: currentEffects
            };
            
            // å°†äº‹ä»¶çš„æ ‡ç­¾æ·»åŠ åˆ°å…¨å±€æ ‡ç­¾åº“
            if (currentTags && currentTags.length > 0) {
                currentTags.forEach(tag => globalTagLibrary.add(tag));
            }
            
            if (editingEvent) {
                // å…ˆç§»é™¤æ—§çš„åŒå‘ç»‘å®š
                const oldCauses = editingEvent.causes || [];
                const oldEffects = editingEvent.effects || [];
                
                oldCauses.forEach(causeId => {
                    const causeEvent = events.find(e => e.id === causeId);
                    if (causeEvent && causeEvent.effects) {
                        causeEvent.effects = causeEvent.effects.filter(id => id !== editingEvent.id);
                    }
                });
                
                oldEffects.forEach(effectId => {
                    const effectEvent = events.find(e => e.id === effectId);
                    if (effectEvent && effectEvent.causes) {
                        effectEvent.causes = effectEvent.causes.filter(id => id !== editingEvent.id);
                    }
                });
                
                // æ›´æ–°äº‹ä»¶æ•°æ®
                Object.assign(editingEvent, eventData);
                alert('âœ… äº‹ä»¶ç¼–è¾‘æˆåŠŸï¼');
            } else {
                const maxId = Math.max(...events.map(e => parseInt(e.id.slice(1))), 0);
                eventData.id = 't' + (maxId + 1);
                events.push(eventData);
                alert('âœ… äº‹ä»¶æ·»åŠ æˆåŠŸï¼');
            }
            
            // å»ºç«‹åŒå‘ç»‘å®š
            const currentEventId = editingEvent ? editingEvent.id : eventData.id;
            
            // ä¸ºèµ·å› äº‹ä»¶æ·»åŠ åå‘é“¾æ¥ï¼ˆå½“å‰äº‹ä»¶æ˜¯å®ƒä»¬çš„ç»“æœï¼‰
            currentCauses.forEach(causeId => {
                const causeEvent = events.find(e => e.id === causeId);
                if (causeEvent) {
                    if (!causeEvent.effects) causeEvent.effects = [];
                    if (!causeEvent.effects.includes(currentEventId)) {
                        causeEvent.effects.push(currentEventId);
                    }
                }
            });
            
            // ä¸ºç»“æœäº‹ä»¶æ·»åŠ åå‘é“¾æ¥ï¼ˆå½“å‰äº‹ä»¶æ˜¯å®ƒä»¬çš„èµ·å› ï¼‰
            currentEffects.forEach(effectId => {
                const effectEvent = events.find(e => e.id === effectId);
                if (effectEvent) {
                    if (!effectEvent.causes) effectEvent.causes = [];
                    if (!effectEvent.causes.includes(currentEventId)) {
                        effectEvent.causes.push(currentEventId);
                    }
                }
            });
            
            closeEventForm();
            render();
        }
        
        function deleteEvent() {
            if (!selectedEvent) return;
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤äº‹ä»¶å—ï¼Ÿ')) return;
            
            events = events.filter(e => e.id !== selectedEvent.id);
            closeEventDetail();
            render();
            alert('âœ… äº‹ä»¶åˆ é™¤æˆåŠŸï¼');
        }
        
        function exportData() {
            const data = {
                events: events,
                days: days,
                exportTime: new Date().toLocaleString('zh-CN')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æ•…äº‹å¤§çº²_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('âœ… å¯¼å‡ºæˆåŠŸï¼');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.events) events = data.events;
                    if (data.days) days = data.days;
                    // å…¼å®¹æ—§æ ¼å¼
                    if (data.chapters && !data.days) {
                        days = data.chapters.map(c => ({
                            id: c.id,
                            name: c.name,
                            startChapter: c.startDay,
                            endChapter: c.endDay
                        }));
                    }
                    render();
                    alert('âœ… å¯¼å…¥æˆåŠŸï¼');
                } catch (err) {
                    alert('âŒ å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function updateDayHint() {
            const startChapter = parseInt(document.getElementById('eventStartTime').value);
            if (isNaN(startChapter)) {
                document.getElementById('chapterHint').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç« èŠ‚å·';
                return;
            }
            
            const day = days.find(d => {
                const min = Math.min(d.startChapter, d.endChapter);
                const max = Math.max(d.startChapter, d.endChapter);
                return startChapter >= min && startChapter <= max;
            });
            const dayName = day ? day.name : 'æœªåˆ†é…åˆ°ä»»ä½•å¤©æ•°';
            document.getElementById('chapterHint').textContent = `å½“å‰å°†å±äºï¼š${dayName}`;
        }
        
        // å¿«é€Ÿæ·»åŠ å¤©æ•°
        function quickAddDay() {
            showDayManager();
            // èšç„¦åˆ°å¤©æ•°åç§°è¾“å…¥æ¡†
            setTimeout(() => {
                const nameInput = document.getElementById('newChapterName');
                if (nameInput) {
                    nameInput.focus();
                    nameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }
        
                function showDayManager() {
            const modal = document.getElementById('chapterManagerModal');
            renderDayList();
            
            // è®¾ç½®æ™ºèƒ½é»˜è®¤å€¼ - åŸºäºå·²æœ‰å¤©æ•°è®¡ç®—
            let maxChapter = 0;
            if (days.length > 0) {
                maxChapter = Math.max(...days.map(d => d.endChapter));
            }
            
            document.getElementById('newChapterStart').value = maxChapter + 1;
            document.getElementById('newChapterEnd').value = maxChapter + 1;
            
            modal.classList.add('show');
        }
        
        function closeDayManager() {
            document.getElementById('chapterManagerModal').classList.remove('show');
        }
        
        function renderDayList() {
            const container = document.getElementById('chapterList');
            container.innerHTML = days.map(day => {
                const chapterCount = Math.abs(day.endChapter - day.startChapter) + 1;
                return `
                <div class="chapter-item" id="chapter-${day.id}">
                    <div class="chapter-item-view">
                        <div class="chapter-info">
                            <h4>${day.name}</h4>
                            <p>${formatChapterRange(day.startChapter, day.endChapter)}ï¼ˆå…±${chapterCount}ç« ï¼‰</p>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="editDay(${day.id})">âœï¸ ç¼–è¾‘</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteDay(${day.id})">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="chapter-item-edit">
                        <div class="form-group">
                            <label class="form-label">å¤©æ•°åç§°</label>
                            <input type="text" class="form-input" id="editChapterName-${day.id}" value="${day.name}">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">èµ·å§‹ç« èŠ‚</label>
                                <input type="number" class="form-input" id="editChapterStart-${day.id}" value="${day.startChapter}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ç»“æŸç« èŠ‚</label>
                                <input type="number" class="form-input" id="editChapterEnd-${day.id}" value="${day.endChapter}">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-secondary btn-sm" onclick="cancelEditDay(${day.id})">âŒ å–æ¶ˆ</button>
                            <button class="btn btn-primary btn-sm" onclick="saveDay(${day.id})">ğŸ’¾ ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        function editDay(id) {
            const item = document.getElementById(`chapter-${id}`);
            if (item) {
                item.classList.add('editing');
            }
        }
        
        function cancelEditDay(id) {
            const item = document.getElementById(`chapter-${id}`);
            if (item) {
                item.classList.remove('editing');
            }
        }
        
        function saveDay(id) {
            const name = document.getElementById(`editChapterName-${id}`).value.trim();
            const startChapter = parseInt(document.getElementById(`editChapterStart-${id}`).value);
            const endChapter = parseInt(document.getElementById(`editChapterEnd-${id}`).value);
            
            if (!name) {
                alert('âŒ è¯·è¾“å…¥å¤©æ•°åç§°');
                return;
            }
            
            if (isNaN(startChapter) || isNaN(endChapter)) {
                alert('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„ç« èŠ‚å·');
                return;
            }
            
            if (endChapter < startChapter) {
                alert(`âŒ ç»“æŸç« èŠ‚ä¸èƒ½å°äºèµ·å§‹ç« èŠ‚ï¼\n\nå½“å‰è®¾ç½®ï¼š${formatChapter(startChapter)} - ${formatChapter(endChapter)}\n\nè¯·ä¿®æ”¹ä¸ºï¼šç»“æŸç« èŠ‚ >= èµ·å§‹ç« èŠ‚\nä¾‹å¦‚ï¼š${formatChapter(startChapter)} - ${formatChapter(startChapter)} æˆ– ${formatChapter(startChapter)} - ${formatChapter(startChapter + 5)}`);
                return;
            }
            
            // æ£€æŸ¥ç« èŠ‚èŒƒå›´é‡å 
            const overlapCheck = checkChapterOverlap(startChapter, endChapter, id);
            if (overlapCheck.overlap) {
                alert(`âŒ ç« èŠ‚èŒƒå›´ä¸ã€Œ${overlapCheck.conflictDay.name}ã€é‡å ï¼\n\n` +
                      `${overlapCheck.conflictDay.name}: ${formatChapterRange(overlapCheck.conflictDay.startChapter, overlapCheck.conflictDay.endChapter)}\n` +
                      `å½“å‰è®¾ç½®: ${formatChapterRange(startChapter, endChapter)}\n\n` +
                      `è¯·è°ƒæ•´ç« èŠ‚èŒƒå›´ï¼Œé¿å…é‡å ã€‚`);
                return;
            }
            
            const day = days.find(d => d.id === id);
            if (day) {
                day.name = name;
                day.startChapter = startChapter;
                day.endChapter = endChapter;
            }
            
            renderDayList();
            render();
            alert('âœ… å¤©æ•°ä¿®æ”¹æˆåŠŸï¼');
        }
        
        // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
        let pendingDeleteId = null;
        
        function showCustomConfirm(message, callback) {
            const modal = document.getElementById('customConfirm');
            const messageEl = document.getElementById('confirmMessage');
            
            if (!modal || !messageEl) {
                console.log('æ‰¾ä¸åˆ°ç¡®è®¤å¯¹è¯æ¡†å…ƒç´ ï¼Œä½¿ç”¨æµè§ˆå™¨confirm');
                return confirm(message);
            }
            
            messageEl.textContent = message;
            modal.style.display = 'flex';
            
            // ä¿å­˜å›è°ƒå‡½æ•°
            window.confirmCallback = callback;
        }
        
        function confirmDelete() {
            const modal = document.getElementById('customConfirm');
            if (modal) {
                modal.style.display = 'none';
            }
            
            if (window.confirmCallback) {
                window.confirmCallback(true);
                window.confirmCallback = null;
            }
        }
        
        function cancelConfirm() {
            const modal = document.getElementById('customConfirm');
            if (modal) {
                modal.style.display = 'none';
            }
            
            if (window.confirmCallback) {
                window.confirmCallback(false);
                window.confirmCallback = null;
            }
        }
        
                function deleteDay(id) {
            console.log('=== å¼€å§‹åˆ é™¤å¤©æ•° ===');
            console.log('ID:', id);
            console.log('å½“å‰daysæ•°ç»„:', days);
            
            const day = days.find(d => d.id === id);
            console.log('æ‰¾åˆ°çš„å¤©æ•°:', day);
            
            if (!day) {
                console.log('é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¯¥å¤©æ•°');
                alert('âŒ æ‰¾ä¸åˆ°è¯¥å¤©æ•°');
                return;
            }
            
            // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
            const message = `ç¡®å®šåˆ é™¤ã€Œ${day.name}ã€å—ï¼Ÿ\n\nç« èŠ‚èŒƒå›´ï¼š${formatChapterRange(day.startChapter, day.endChapter)}`;
            console.log('å‡†å¤‡æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†');
            
            showCustomConfirm(message, function(confirmed) {
                console.log('ç¡®è®¤å¯¹è¯æ¡†ç»“æœ:', confirmed);
                
                if (!confirmed) {
                    console.log('ç”¨æˆ·å–æ¶ˆåˆ é™¤');
                    return;
                }
                
                console.log('ç”¨æˆ·ç¡®è®¤åˆ é™¤ï¼Œå¼€å§‹æ‰§è¡Œåˆ é™¤æ“ä½œ');
                const beforeLength = days.length;
                days = days.filter(d => d.id !== id);
                const afterLength = days.length;
                
                console.log('åˆ é™¤å‰æ•°é‡:', beforeLength);
                console.log('åˆ é™¤åæ•°é‡:', afterLength);
                console.log('åˆ é™¤åçš„daysæ•°ç»„:', days);
                
                if (beforeLength === afterLength) {
                    console.log('è­¦å‘Šï¼šåˆ é™¤å¤±è´¥ï¼Œæ•°é‡æ²¡æœ‰å˜åŒ–');
                    alert('âŒ åˆ é™¤å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }
                
                console.log('æ›´æ–°åˆ—è¡¨å’Œæ¸²æŸ“');
                renderDayList();
                render();
                
                console.log('åˆ é™¤å®Œæˆ');
                alert(`âœ… å·²åˆ é™¤ã€Œ${day.name}ã€`);
            });
        }
        
        
        // è‡ªå®šä¹‰è‡ªåŠ¨ç”Ÿæˆå¤©æ•°
        function autoGenerateDaysCustom() {
            const startDayInput = document.getElementById('autoStartDay');
            const chaptersPerDayInput = document.getElementById('autoChaptersPerDay');
            
            if (!startDayInput || !chaptersPerDayInput) {
                alert('âŒ æ‰¾ä¸åˆ°è¾“å…¥æ¡†');
                return;
            }
            
            const startDay = parseInt(startDayInput.value) || 1;
            const chaptersPerDay = parseInt(chaptersPerDayInput.value) || 1;
            
            if (startDay < 1 || chaptersPerDay < 1) {
                alert('âŒ èµ·å§‹å¤©æ•°å’Œæ¯å¤©ç« èŠ‚æ•°å¿…é¡»å¤§äº0');
                return;
            }
            
            // è¯¢é—®æ˜¯å¦æ¸…ç©ºç°æœ‰å¤©æ•°
            let shouldClear = false;
            if (days.length > 0) {
                shouldClear = confirm(`å½“å‰å·²æœ‰ ${days.length} ä¸ªå¤©æ•°æ®µã€‚\n\nç‚¹å‡»"ç¡®å®š"å°†æ¸…ç©ºç°æœ‰å¤©æ•°å¹¶é‡æ–°ç”Ÿæˆ\nç‚¹å‡»"å–æ¶ˆ"å°†åœ¨ç°æœ‰å¤©æ•°åŸºç¡€ä¸Šè¿½åŠ `);
                if (shouldClear) {
                    days = [];
                }
            }
            
            // æ‰¾å‡ºæ‰€æœ‰äº‹ä»¶çš„ç« èŠ‚èŒƒå›´
            let minChapter = 1;
            let maxChapter = 10;
            
            if (events.length > 0) {
                minChapter = Math.min(...events.map(e => e.startTime));
                maxChapter = Math.max(...events.map(e => e.startTime + e.duration));
            }
            
            // æŒ‰ç…§è§„åˆ™ç”Ÿæˆå¤©æ•°
            let newDaysCount = 0;
            let currentDay = startDay;
            
            for (let chapter = minChapter; chapter <= maxChapter; chapter += chaptersPerDay) {
                const endChapter = Math.min(chapter + chaptersPerDay - 1, maxChapter);
                
                // æ£€æŸ¥è¿™ä¸ªèŒƒå›´æ˜¯å¦å·²ç»æœ‰å¤©æ•°äº†
                const existing = days.find(d => 
                    d.startChapter === chapter && d.endChapter === endChapter
                );
                
                if (!existing) {
                    let dayName;
                    if (chaptersPerDay === 1) {
                        dayName = `ç¬¬${currentDay}å¤©`;
                    } else {
                        dayName = `ç¬¬${currentDay}å¤©`;
                    }
                    
                    days.push({
                        id: Date.now() + newDaysCount * 10,
                        name: dayName,
                        startChapter: chapter,
                        endChapter: endChapter
                    });
                    newDaysCount++;
                }
                currentDay++;
            }
            
            renderDayList();
            render();
            
            if (newDaysCount > 0) {
                alert(`âœ… è‡ªåŠ¨ç”Ÿæˆå®Œæˆï¼\n\næ–°å¢äº† ${newDaysCount} ä¸ªå¤©æ•°æ®µ\nä»ç¬¬${startDay}å¤©å¼€å§‹\næ¯å¤©${chaptersPerDay}ç« `);
            } else {
                alert('â„¹ï¸ æ‰€æœ‰ç« èŠ‚éƒ½å·²æœ‰å¯¹åº”çš„å¤©æ•°æ®µ\næ— éœ€ç”Ÿæˆ');
            }
        }
        
        function addDay() {
            const name = document.getElementById('newChapterName').value.trim();
            const startChapter = parseInt(document.getElementById('newChapterStart').value) || 0;
            const endChapter = parseInt(document.getElementById('newChapterEnd').value) || 0;
            
            if (!name) {
                alert('è¯·è¾“å…¥å¤©æ•°åç§°');
                return;
            }
            
            // æ£€æŸ¥ç« èŠ‚èŒƒå›´é‡å 
            const overlapCheck = checkChapterOverlap(startChapter, endChapter);
            if (overlapCheck.overlap) {
                alert(`âŒ ç« èŠ‚èŒƒå›´ä¸ã€Œ${overlapCheck.conflictDay.name}ã€é‡å ï¼\n\n` +
                      `${overlapCheck.conflictDay.name}: ${formatChapterRange(overlapCheck.conflictDay.startChapter, overlapCheck.conflictDay.endChapter)}\n` +
                      `å½“å‰è®¾ç½®: ${formatChapterRange(startChapter, endChapter)}\n\n` +
                      `è¯·è°ƒæ•´ç« èŠ‚èŒƒå›´ï¼Œé¿å…é‡å ã€‚ä¾‹å¦‚ï¼š\n` +
                      `â€¢ åœ¨å‰é¢ï¼š${formatChapter(Math.min(overlapCheck.conflictDay.startChapter, overlapCheck.conflictDay.endChapter) - 10)}-${formatChapter(Math.min(overlapCheck.conflictDay.startChapter, overlapCheck.conflictDay.endChapter) - 1)}\n` +
                      `â€¢ åœ¨åé¢ï¼š${formatChapter(Math.max(overlapCheck.conflictDay.startChapter, overlapCheck.conflictDay.endChapter) + 1)}-${formatChapter(Math.max(overlapCheck.conflictDay.startChapter, overlapCheck.conflictDay.endChapter) + 10)}`);
                return;
            }
            
            const maxId = Math.max(...days.map(d => d.id), 0);
            days.push({
                id: maxId + 1,
                name,
                startChapter,
                endChapter
            });
            
            // æ¸…ç©ºåç§°è¾“å…¥æ¡†
            document.getElementById('newChapterName').value = '';
            
            // é‡æ–°è®¡ç®—ä¸‹ä¸€ä¸ªé»˜è®¤å€¼
            let nextChapter = 0;
            if (days.length > 0) {
                nextChapter = Math.max(...days.map(d => d.endChapter));
            }
            document.getElementById('newChapterStart').value = nextChapter + 1;
            document.getElementById('newChapterEnd').value = nextChapter + 1;
            
            renderDayList();
            render();
            alert('âœ… å¤©æ•°æ·»åŠ æˆåŠŸï¼');
        }
        
        function showTagManager() {
            const modal = document.getElementById('tagManagerModal');
            modal.classList.add('show');
            
            // å»¶è¿Ÿæ¸²æŸ“ï¼Œç¡®ä¿modalå·²ç»æ˜¾ç¤º
            setTimeout(() => {
                renderEventCheckboxList(); // æ¸²æŸ“äº‹ä»¶å¤é€‰æ¡†åˆ—è¡¨
                renderTagManager();
            }, 50);
        }
        
        
        // é¢œè‰²è‡ªå®šä¹‰
        let customColors = {
            bgColor: '#111827',
            bgImage: '',
            hiddenColor: '#1e1b4b',
            hiddenImage: '',
            surfaceColor: '#0c4a6e',
            surfaceImage: '',
            hiddenEventColor: '#a855f7',
            surfaceEventColor: '#3b82f6',
            gridOpacity: 30,
            gridColor: '#8b5cf6',
            dividerBgColor: '#8b5cf6',
            dividerColor: '#a78bfa',
            chapterScaleColor: '#d8b4fe',
            dayScaleColor: '#fbbf24'
        };
        
        function showColorCustomizer() {
            const modal = document.getElementById('colorCustomizer');
            if (!modal) return;
            
            modal.style.display = 'flex';
            
            // åŠ è½½å½“å‰è®¾ç½®ï¼ˆå®‰å…¨è®¿é—®ï¼‰
            const inputs = {
                bgColor: document.getElementById('bgColor'),
                bgImage: document.getElementById('bgImage'),
                hiddenColor: document.getElementById('hiddenColor'),
                hiddenImage: document.getElementById('hiddenImage'),
                surfaceColor: document.getElementById('surfaceColor'),
                surfaceImage: document.getElementById('surfaceImage'),
                hiddenEventColor: document.getElementById('hiddenEventColor'),
                surfaceEventColor: document.getElementById('surfaceEventColor'),
                gridOpacity: document.getElementById('gridOpacity'),
                opacityValue: document.getElementById('opacityValue'),
                gridColor: document.getElementById('gridColor'),
                dividerBgColor: document.getElementById('dividerBgColor'),
                dividerColor: document.getElementById('dividerColor'),
                chapterScaleColor: document.getElementById('chapterScaleColor'),
                dayScaleColor: document.getElementById('dayScaleColor')
            };
            
            if (inputs.bgColor) inputs.bgColor.value = customColors.bgColor;
            if (inputs.bgImage) inputs.bgImage.value = customColors.bgImage;
            if (inputs.hiddenColor) inputs.hiddenColor.value = customColors.hiddenColor;
            if (inputs.hiddenImage) inputs.hiddenImage.value = customColors.hiddenImage;
            if (inputs.surfaceColor) inputs.surfaceColor.value = customColors.surfaceColor;
            if (inputs.surfaceImage) inputs.surfaceImage.value = customColors.surfaceImage;
            if (inputs.hiddenEventColor) inputs.hiddenEventColor.value = customColors.hiddenEventColor;
            if (inputs.surfaceEventColor) inputs.surfaceEventColor.value = customColors.surfaceEventColor;
            if (inputs.gridOpacity) inputs.gridOpacity.value = customColors.gridOpacity;
            if (inputs.opacityValue) inputs.opacityValue.textContent = customColors.gridOpacity + '%';
            if (inputs.gridColor) inputs.gridColor.value = customColors.gridColor;
            if (inputs.dividerBgColor) inputs.dividerBgColor.value = customColors.dividerBgColor;
            if (inputs.dividerColor) inputs.dividerColor.value = customColors.dividerColor;
            if (inputs.chapterScaleColor) inputs.chapterScaleColor.value = customColors.chapterScaleColor;
            if (inputs.dayScaleColor) inputs.dayScaleColor.value = customColors.dayScaleColor;
        }
        
        function closeColorCustomizer() {
            const modal = document.getElementById('colorCustomizer');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function updateColors() {
            // æ›´æ–°é€æ˜åº¦æ˜¾ç¤º
            const opacityInput = document.getElementById('gridOpacity');
            const opacityValue = document.getElementById('opacityValue');
            
            if (opacityInput && opacityValue) {
                opacityValue.textContent = opacityInput.value + '%';
            }
            
            // å®æ—¶é¢„è§ˆ
            applyColors();
        }
        
        function applyColors() {
            // å…ˆæ£€æŸ¥è¾“å…¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            const bgColorInput = document.getElementById('bgColor');
            const bgImageInput = document.getElementById('bgImage');
            const hiddenColorInput = document.getElementById('hiddenColor');
            const hiddenImageInput = document.getElementById('hiddenImage');
            const surfaceColorInput = document.getElementById('surfaceColor');
            const surfaceImageInput = document.getElementById('surfaceImage');
            const gridOpacityInput = document.getElementById('gridOpacity');
            const dividerColorInput = document.getElementById('dividerColor');
            const chapterScaleColorInput = document.getElementById('chapterScaleColor');
            const dayScaleColorInput = document.getElementById('dayScaleColor');
            const gridColorInput = document.getElementById('gridColor');
            
            if (!bgColorInput || !hiddenColorInput || !surfaceColorInput) {
                // è¾“å…¥å…ƒç´ è¿˜ä¸å­˜åœ¨ï¼Œè·³è¿‡
                return;
            }
            
            const bgColor = bgColorInput.value;
            const bgImage = bgImageInput.value;
            const hiddenColor = hiddenColorInput.value;
            const hiddenImage = hiddenImageInput.value;
            const surfaceColor = surfaceColorInput.value;
            const surfaceImage = surfaceImageInput.value;
            const opacity = gridOpacityInput.value / 100;
            const dividerColor = dividerColorInput ? dividerColorInput.value : '#a78bfa';
            const chapterScaleColor = chapterScaleColorInput ? chapterScaleColorInput.value : '#d8b4fe';
            const dayScaleColor = dayScaleColorInput ? dayScaleColorInput.value : '#fbbf24';
            const gridColorHex = gridColorInput ? gridColorInput.value : '#8b5cf6';
            const gridRgb = hexToRgb(gridColorHex);
            const dividerBgColorInput = document.getElementById('dividerBgColor');
            const dividerBgColor = dividerBgColorInput ? dividerBgColorInput.value : '#8b5cf6';
            
            // åº”ç”¨ç½‘é¡µèƒŒæ™¯
            if (bgImage) {
                document.body.style.backgroundImage = `url(${bgImage})`;
                document.body.style.backgroundColor = bgColor;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundAttachment = 'fixed';
            } else {
                document.body.style.backgroundImage = 'none';
                document.body.style.backgroundColor = bgColor;
            }
            
            // åº”ç”¨æš—å±‚èƒŒæ™¯
            const hiddenArea = document.querySelector('.hidden-layer-area');
            if (hiddenArea) {
                if (hiddenImage) {
                    hiddenArea.style.backgroundImage = `url(${hiddenImage}), repeating-linear-gradient(90deg, transparent 0, transparent calc(var(--chapter-width, 50px) - 2px), rgba(${gridRgb.r}, ${gridRgb.g}, ${gridRgb.b}, ${opacity}) calc(var(--chapter-width, 50px) - 2px), rgba(${gridRgb.r}, ${gridRgb.g}, ${gridRgb.b}, ${opacity}) var(--chapter-width, 50px)), repeating-linear-gradient(90deg, transparent 0, transparent calc(var(--day-width, 10px) - 1px), rgba(${gridRgb.r}, ${gridRgb.g}, ${gridRgb.b}, ${opacity * 0.3}) calc(var(--day-width, 10px) - 1px), rgba(${gridRgb.r}, ${gridRgb.g}, ${gridRgb.b}, ${opacity * 0.3}) var(--day-width, 10px))`;
                    hiddenArea.style.backgroundSize = 'cover, auto, auto';
                    hiddenArea.style.backgroundColor = hiddenColor;
                } else {
                    hiddenArea.style.backgroundImage = `repeating-linear-gradient(90deg, transparent 0, transparent calc(var(--chapter-width, 50px) - 2px), rgba(${gridRgb.r}, ${gridRgb.g}, ${gridRgb.b}, ${opacity}) calc(var(--chapter-width, 50px) - 2px), rgba(${gridRgb.r}, ${gridRgb.g}, ${gridRgb.b}, ${opacity}) var(--chapter-width, 50px)), repeating-linear-gradient(90deg, transparent 0, transparent calc(var(--day-width, 10px) - 1px), rgba(${gridRgb.r}, ${gridRgb.g}, ${gridRgb.b}, ${opacity * 0.3}) calc(var(--day-width, 10px) - 1px), rgba(${gridRgb.r}, ${gridRgb.g}, ${gridRgb.b}, ${opacity * 0.3}) var(--day-width, 10px))`;
                    hiddenArea.style.backgroundColor = hiddenColor;
                }
            }
            
            // åº”ç”¨è¡¨å±‚èƒŒæ™¯
            const surfaceArea = document.querySelector('.surface-layer-area');
            if (surfaceArea) {
                if (surfaceImage) {
                    surfaceArea.style.backgroundImage = `url(${surfaceImage}), repeating-linear-gradient(90deg, transparent 0, transparent calc(var(--chapter-width, 50px) - 2px), rgba(${gridRgb.r}, ${gridRgb.g}, ${gridRgb.b}, ${opacity}) calc(var(--chapter-width, 50px) - 2px), rgba(${gridRgb.r}, ${gridRgb.g}, ${gridRgb.b}, ${opacity}) var(--chapter-width, 50px)), repeating-linear-gradient(90deg, transparent 0, transparent calc(var(--day-width, 10px) - 1px), rgba(${gridRgb.r}, ${gridRgb.g}, ${gridRgb.b}, ${opacity * 0.3}) calc(var(--day-width, 10px) - 1px), rgba(${gridRgb.r}, ${gridRgb.g}, ${gridRgb.b}, ${opacity * 0.3}) var(--day-width, 10px))`;
                    surfaceArea.style.backgroundSize = 'cover, auto, auto';
                    surfaceArea.style.backgroundColor = surfaceColor;
                } else {
                    surfaceArea.style.backgroundImage = `repeating-linear-gradient(90deg, transparent 0, transparent calc(var(--chapter-width, 50px) - 2px), rgba(${gridRgb.r}, ${gridRgb.g}, ${gridRgb.b}, ${opacity}) calc(var(--chapter-width, 50px) - 2px), rgba(${gridRgb.r}, ${gridRgb.g}, ${gridRgb.b}, ${opacity}) var(--chapter-width, 50px)), repeating-linear-gradient(90deg, transparent 0, transparent calc(var(--day-width, 10px) - 1px), rgba(${gridRgb.r}, ${gridRgb.g}, ${gridRgb.b}, ${opacity * 0.3}) calc(var(--day-width, 10px) - 1px), rgba(${gridRgb.r}, ${gridRgb.g}, ${gridRgb.b}, ${opacity * 0.3}) var(--day-width, 10px))`;
                    surfaceArea.style.backgroundColor = surfaceColor;
                }
            }
            
            // åº”ç”¨åˆ†éš”çº¿é¢œè‰²å’ŒèƒŒæ™¯
            const dividers = document.querySelectorAll('.layer-divider');
            dividers.forEach(div => {
                div.style.borderTopColor = dividerColor;
                div.style.borderBottomColor = dividerColor;
                // åˆ›å»ºä»dividerBgColorçš„æ¸å˜ï¼ˆå•è‰²åˆ°ç¨å¾®ä¸åŒçš„è‰²è°ƒï¼‰
                const rgb = hexToRgb(dividerBgColor);
                const lighter = `rgb(${Math.min(255, rgb.r + 30)}, ${Math.min(255, rgb.g + 30)}, ${Math.min(255, rgb.b + 30)})`;
                const darker = `rgb(${Math.max(0, rgb.r - 20)}, ${Math.max(0, rgb.g - 20)}, ${Math.max(0, rgb.b - 20)})`;
                div.style.background = `linear-gradient(90deg, ${dividerBgColor} 0%, ${lighter} 50%, ${darker} 100%)`;
            });
            
            // åº”ç”¨ç« èŠ‚åˆ»åº¦é¢œè‰²
            const chapterMarkers = document.querySelectorAll('.chapter-marker');
            chapterMarkers.forEach(marker => {
                marker.style.color = chapterScaleColor;
            });
            
            // åº”ç”¨å¤©æ•°åˆ»åº¦é¢œè‰²
            const dayMarkers = document.querySelectorAll('.day-marker');
            dayMarkers.forEach(marker => {
                marker.style.color = dayScaleColor;
                // æ›´æ–°æè¾¹é¢œè‰²
                marker.style.textShadow = `2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000`;
            });
            
            // æ›´æ–°æ ‡ç­¾é¢œè‰²
            setTimeout(() => {
                updateLabelColors();
            }, 100);
        }
        
        function saveColors() {
            customColors = {
                bgColor: document.getElementById('bgColor').value,
                bgImage: document.getElementById('bgImage').value,
                hiddenColor: document.getElementById('hiddenColor').value,
                hiddenImage: document.getElementById('hiddenImage').value,
                surfaceColor: document.getElementById('surfaceColor').value,
                surfaceImage: document.getElementById('surfaceImage').value,
                hiddenEventColor: document.getElementById('hiddenEventColor').value,
                surfaceEventColor: document.getElementById('surfaceEventColor').value,
                gridOpacity: parseInt(document.getElementById('gridOpacity').value),
                gridColor: document.getElementById('gridColor').value,
                dividerBgColor: document.getElementById('dividerBgColor').value,
                dividerColor: document.getElementById('dividerColor').value,
                chapterScaleColor: document.getElementById('chapterScaleColor').value,
                dayScaleColor: document.getElementById('dayScaleColor').value
            };
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('customColors', JSON.stringify(customColors));
            
            applyColors();
            closeColorCustomizer();
            
            alert('âœ… é¢œè‰²è®¾ç½®å·²ä¿å­˜ï¼');
        }
        
        function resetColors() {
            customColors = {
                bgColor: '#111827',
                bgImage: '',
                hiddenColor: '#1e1b4b',
                hiddenImage: '',
                surfaceColor: '#0c4a6e',
                surfaceImage: '',
                hiddenEventColor: '#a855f7',
                surfaceEventColor: '#3b82f6',
                gridOpacity: 30,
                gridColor: '#8b5cf6',
                dividerBgColor: '#8b5cf6',
                dividerColor: '#a78bfa',
                chapterScaleColor: '#d8b4fe',
                dayScaleColor: '#fbbf24'
            };
            
            showColorCustomizer();
            applyColors();
        }
        
        // é¡µé¢åŠ è½½æ—¶æ¢å¤é¢œè‰²è®¾ç½®
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('customColors');
            if (saved) {
                customColors = JSON.parse(saved);
                // å»¶è¿Ÿåº”ç”¨é¢œè‰²ï¼Œç¡®ä¿å…ƒç´ å·²æ¸²æŸ“
                setTimeout(() => {
                    applyColors();
                }, 100);
            }
        });

        function closeTagManager() {
            document.getElementById('tagManagerModal').classList.remove('show');
        }
        

        // æŒ‰æ ‡ç­¾ç­›é€‰
        function filterByTag(tag) {
            filteredTag = tag;
            render();
            closeTagManager();
            showFilterHint(tag);
        }
        
        // æ¸…é™¤ç­›é€‰
        function clearTagFilter() {
            filteredTag = null;
            render();
            hideFilterHint();
        }
        
        // æ˜¾ç¤ºç­›é€‰æç¤º
        function showFilterHint(tag) {
            const hint = document.getElementById('timelineHint');
            hint.innerHTML = `
                <span>ğŸ” å½“å‰ç­›é€‰: <strong>${tag}</strong></span>
                <button class="btn btn-sm btn-danger" onclick="clearTagFilter()" style="padding: 6px 14px; margin-left: 10px;">
                    âœ– æ¸…é™¤ç­›é€‰
                </button>
            `;
            hint.style.background = '#fef3c7';
            hint.style.padding = '12px 20px';
        }
        
        // éšè—ç­›é€‰æç¤º
        function hideFilterHint() {
            const hint = document.getElementById('timelineHint');
            hint.innerHTML = editMode ? 
                'æ‹–åŠ¨äº‹ä»¶å¯æ”¹å˜ä½ç½®å’Œç« èŠ‚ï¼Œæ‹–åŠ¨å³è¾¹ç¼˜å¯è°ƒæ•´æŒç»­ç« èŠ‚æ•°' : 
                'ç‚¹å‡»äº‹ä»¶æŸ¥çœ‹è¯¦æƒ…';
            hint.style.background = '';
            hint.style.padding = '';
        }
        



        // æ¸²æŸ“äº‹ä»¶å¤é€‰æ¡†åˆ—è¡¨
        function renderEventCheckboxList() {
            const container = document.getElementById('eventCheckboxList');
            if (!container) {
                console.log('eventCheckboxListå®¹å™¨æœªæ‰¾åˆ°ï¼Œå»¶è¿Ÿæ¸²æŸ“');
                // å¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œç­‰å¾…ä¸€ä¸‹å†æ¸²æŸ“
                setTimeout(renderEventCheckboxList, 100);
                return;
            }
            
            if (events.length === 0) {
                container.innerHTML = '<p style="color: #9ca3af; font-style: italic;">æš‚æ— äº‹ä»¶</p>';
                return;
            }
            
            container.innerHTML = events.map(event => `
                <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 6px; transition: background 0.2s;" 
                       onmouseover="this.style.background='#f3f4f6'" 
                       onmouseout="this.style.background='transparent'">
                    <input type="checkbox" value="${event.id}" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                    <span style="flex: 1;">${event.title}</span>
                    <span style="color: #9ca3af; font-size: 12px;">${formatChapter(event.startTime)}</span>
                </label>
            `).join('');
            console.log(`å·²æ¸²æŸ“ ${events.length} ä¸ªäº‹ä»¶åˆ°å¤é€‰æ¡†åˆ—è¡¨`);
        }
        
        // åˆ›å»ºæ–°æ ‡ç­¾
        function createNewTag() {
            const input = document.getElementById('newTagInput');
            let tag = input.value.trim();
            
            if (!tag) {
                alert('âŒ è¯·è¾“å…¥æ ‡ç­¾åç§°');
                return;
            }
            
            // è‡ªåŠ¨æ·»åŠ #å·
            if (!tag.startsWith('#')) {
                tag = '#' + tag;
            }
            
            // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
            if (globalTagLibrary.has(tag)) {
                alert(`âš ï¸ æ ‡ç­¾ "${tag}" å·²å­˜åœ¨ï¼`);
                return;
            }
            
            // è·å–é€‰ä¸­çš„äº‹ä»¶
            const checkboxes = document.querySelectorAll('#eventCheckboxList input[type="checkbox"]:checked');
            const selectedEventIds = Array.from(checkboxes).map(cb => cb.value);
            
            // æ·»åŠ åˆ°å…¨å±€æ ‡ç­¾åº“
            globalTagLibrary.add(tag);
            
            // æ·»åŠ æ ‡ç­¾åˆ°é€‰ä¸­çš„äº‹ä»¶
            let addedCount = 0;
            events.forEach(event => {
                if (selectedEventIds.includes(event.id)) {
                    if (!event.tags) {
                        event.tags = [];
                    }
                    if (!event.tags.includes(tag)) {
                        event.tags.push(tag);
                        addedCount++;
                    }
                }
            });
            
            input.value = '';
            renderEventCheckboxList(); // é‡æ–°æ¸²æŸ“å¤é€‰æ¡†ï¼ˆæ¸…ç©ºé€‰ä¸­çŠ¶æ€ï¼‰
            renderTagManager();
            render(); // åˆ·æ–°æ—¶é—´çº¿
            
            if (addedCount > 0) {
                console.log(`âœ… æ ‡ç­¾ "${tag}" å·²åˆ›å»ºå¹¶æ·»åŠ åˆ° ${addedCount} ä¸ªäº‹ä»¶`);
            } else {
                console.log(`âœ… æ ‡ç­¾ "${tag}" å·²åˆ›å»º`);
            }
        }
        

        // å¤„ç†åˆ é™¤æ ‡ç­¾æŒ‰é’®ç‚¹å‡»
        function handleDeleteTag(button) {
            console.log('handleDeleteTagè¢«è°ƒç”¨');
            const tag = button.getAttribute('data-tag');
            console.log('è¦åˆ é™¤çš„æ ‡ç­¾:', tag);
            if (!tag) {
                alert('é”™è¯¯ï¼šæ— æ³•è·å–æ ‡ç­¾å');
                return;
            }
            executeDeleteTag(tag); // ç›´æ¥åˆ é™¤ï¼Œä¸éœ€è¦ç¡®è®¤
        }
        
        // æ‰§è¡Œåˆ é™¤æ ‡ç­¾
        function executeDeleteTag(tag) {
            console.log('executeDeleteTagè¢«è°ƒç”¨ï¼Œæ ‡ç­¾:', tag);
            console.log('å½“å‰globalTagLibrary:', Array.from(globalTagLibrary));
            console.log('å½“å‰events:', events);
            
            console.log('å¼€å§‹åˆ é™¤æ ‡ç­¾');
            
            // ä»å…¨å±€æ ‡ç­¾åº“ä¸­åˆ é™¤
            globalTagLibrary.delete(tag);
            
            // ä»æ‰€æœ‰äº‹ä»¶ä¸­ç§»é™¤è¯¥æ ‡ç­¾
            let removedCount = 0;
            events.forEach(event => {
                if (event.tags && event.tags.includes(tag)) {
                    event.tags = event.tags.filter(t => t !== tag);
                    removedCount++;
                }
            });
            
            // å¦‚æœå½“å‰æ­£åœ¨ç­›é€‰è¿™ä¸ªæ ‡ç­¾ï¼Œæ¸…é™¤ç­›é€‰
            if (filteredTag === tag) {
                clearTagFilter();
            }
            
            // é‡æ–°æ¸²æŸ“æ ‡ç­¾ç®¡ç†å™¨
            console.log('å‡†å¤‡é‡æ–°æ¸²æŸ“');
            console.log('åˆ é™¤åglobalTagLibrary:', Array.from(globalTagLibrary));
            renderTagManager();
            render();
            console.log('æ¸²æŸ“å®Œæˆ');
            
            // ä¸æ˜¾ç¤ºalertï¼Œç›´æ¥åˆ é™¤å³å¯
            console.log(`âœ… å·²åˆ é™¤æ ‡ç­¾ "${tag}"ï¼Œä» ${removedCount} ä¸ªäº‹ä»¶ä¸­ç§»é™¤`);
        }
        
        function renderTagManager() {
            const tagMap = new Map();
            
            // æ”¶é›†æ‰€æœ‰äº‹ä»¶ä¸­ä½¿ç”¨çš„æ ‡ç­¾
            events.forEach(event => {
                if (event.tags) {
                    event.tags.forEach(tag => {
                        // ä¸åœ¨è¿™é‡Œä¿®æ”¹globalTagLibraryï¼Œé¿å…é‡æ–°æ·»åŠ å·²åˆ é™¤çš„æ ‡ç­¾
                        if (!tagMap.has(tag)) {
                            tagMap.set(tag, []);
                        }
                        tagMap.get(tag).push(event);
                    });
                }
            });
            
            // æ·»åŠ å…¨å±€åº“ä¸­æœªä½¿ç”¨çš„æ ‡ç­¾
            globalTagLibrary.forEach(tag => {
                if (!tagMap.has(tag)) {
                    tagMap.set(tag, []);
                }
            });
            
            const tags = Array.from(tagMap.entries()).sort((a, b) => b[1].length - a[1].length);
            
            const container = document.getElementById('tagManagerBody');
            
            if (tags.length === 0) {
                container.innerHTML = '<div class="info-box"><p>æš‚æ— æ ‡ç­¾</p></div>';
                return;
            }
            
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p class="hint">å…±æœ‰ ${tags.length} ä¸ªæ ‡ç­¾ï¼Œç‚¹å‡»æ ‡ç­¾åç§°å¯ä»¥æŸ¥çœ‹ä½¿ç”¨è¯¥æ ‡ç­¾çš„æ‰€æœ‰äº‹ä»¶</p>
                </div>
                ${tags.map(([tag, tagEvents]) => `
                    <div class="tag-stat-item">
                        <div class="tag-stat-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="tag-stat-name" style="cursor: pointer; text-decoration: underline;" onclick="filterByTag('${tag.replace(/'/g, "\\'")}')"><strong>${tag}</strong></span>
                                <button class="btn btn-danger btn-sm" data-tag="${tag}" onclick="handleDeleteTag(this)" style="padding: 4px 10px; font-size: 12px;">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </div>
                            <span class="tag-stat-count">${tagEvents.length} ä¸ªäº‹ä»¶</span>
                        </div>
                        <div class="tag-stat-events">
                            ${tagEvents.length > 0 ? tagEvents.map(e => e.title).join('ã€') : '<span style="font-style: italic; color: #9ca3af;">æœªä½¿ç”¨</span>'}
                        </div>
                    </div>
                `).join('')}
            `;
        }
        
        // Initialize app
        init();
    </script>
</body>
</html>
