<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•…äº‹å¤§çº²ç®¡ç†å™¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #ffb300 0%, #000000 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            color: white;
        }
        .title { font-size: 32px; font-weight: bold; }
        .btn-group { display: flex; gap: 10px; }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-purple { background: #8b5cf6; color: white; }
        .btn-indigo { background: #6366f1; color: white; }
        
        .timeline-container {
            background: #1f2937;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .timeline-toolbar {
            background: #374151;
            padding: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .timeline-toolbar .btn { padding: 8px 16px; font-size: 14px; }
        .timeline-toolbar span { color: white; font-weight: bold; }
        
        .timeline-canvas {
            background: #1f2937;
            overflow: auto;
            max-height: 600px;
            position: relative;
        }
        .timeline-header {
            background: #111827;
            height: 60px;
            border-bottom: 2px solid #4b5563;
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            padding: 0 20px;
        }
        .chapter-label {
            color: white;
            font-weight: bold;
            text-align: center;
            border-right: 1px solid #4b5563;
            padding: 10px;
        }
        .chapter-sublabel {
            color: #9ca3af;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .timeline-grid {
            min-height: 400px;
            position: relative;
            padding: 20px;
        }
        .event-block {
            position: absolute;
            height: 70px;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: transform 0.2s;
            border: 2px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            user-select: none;
        }
        .event-block.editable {
            cursor: grab;
        }
        .event-block:hover { transform: scaleY(1.02); z-index: 5; }
        .event-block.dragging {
            cursor: grabbing;
            opacity: 0.8;
            z-index: 100;
            transform: scale(1.1);
        }
        .event-block.selected { 
            border: 4px solid #fbbf24;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }
        .event-title {
            color: white;
            font-weight: bold;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .event-time {
            color: rgba(255,255,255,0.9);
            font-size: 12px;
            margin-top: 4px;
        }
        .event-tags {
            display: flex;
            gap: 4px;
            margin-top: 4px;
            flex-wrap: wrap;
        }
        .event-tag {
            background: rgba(0,0,0,0.3);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }
        .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 16px;
            background: rgba(255,255,255,0.8);
            cursor: ew-resize;
            display: none;
            align-items: center;
            justify-content: center;
            border-left: 2px solid white;
        }
        .event-block.editable .resize-handle {
            display: flex;
        }
        .resize-handle:hover { background: white; }
        .resize-handle::before {
            content: 'â‹®';
            color: rgba(0,0,0,0.5);
            font-size: 18px;
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-size: 24px; font-weight: bold; color: #111827; }
        .modal-close {
            background: none;
            border: none;
            font-size: 32px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 32px;
            height: 32px;
            line-height: 32px;
        }
        .modal-close:hover { color: #111827; background: #f3f4f6; border-radius: 4px; }
        .modal-body { padding: 20px; }
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .form-group { margin-bottom: 15px; }
        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #111827;
        }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .info-box {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .info-box h3 {
            color: #111827;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .info-box p { color: #4b5563; line-height: 1.6; }
        
        .tag-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .tag-item {
            background: #dbeafe;
            color: #1e40af;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tag-remove {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #1e40af;
            padding: 0;
            line-height: 1;
        }
        .tag-input-group {
            display: flex;
            gap: 8px;
        }
        
        .hint { font-size: 12px; color: #6b7280; margin-top: 4px; }
        
        .timeline-hint {
            background: #374151;
            padding: 10px;
            text-align: center;
            color: #9ca3af;
            font-size: 14px;
        }
        .timeline-scale {
            background: #1f2937;
            border-top: 1px solid #4b5563;
            padding: 5px 20px;
            color: #9ca3af;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }
        
        .chapter-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .chapter-item-view {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chapter-item-edit {
            display: none;
        }
        .chapter-item.editing .chapter-item-view {
            display: none;
        }
        .chapter-item.editing .chapter-item-edit {
            display: block;
        }
        .chapter-info h4 {
            font-weight: bold;
            color: #111827;
            margin-bottom: 5px;
        }
        .chapter-info p {
            color: #6b7280;
            font-size: 14px;
        }
        .tag-stat-item {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .tag-stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .tag-stat-name {
            font-weight: bold;
            color: #1e40af;
            cursor: pointer;
        }
        .tag-stat-name:hover {
            color: #1e3a8a;
        }
        .tag-stat-count {
            color: #6b7280;
            font-size: 14px;
        }
        .tag-stat-events {
            color: #4b5563;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .btn-sm { padding: 6px 12px; font-size: 14px; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">ğŸ“– æ•…äº‹å¤§çº²ç®¡ç†å™¨ v1.0</div>
            <div class="btn-group">
                <button class="btn btn-purple" onclick="exportData()">ğŸ“¥ å¯¼å‡º</button>
                <label class="btn btn-indigo" style="margin: 0;">
                    ğŸ“¤ å¯¼å…¥
                    <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                </label>
                <button class="btn btn-primary" id="editModeBtn" onclick="toggleEditMode()">âœ ç¼–è¾‘</button>
            </div>
        </div>
        
        <div class="timeline-container">
            <div class="timeline-toolbar">
                <button class="btn btn-secondary btn-sm" onclick="zoomOut()">ğŸ”âˆ’</button>
                <input type="number" 
                       id="zoomInput" 
                       value="100" 
                       min="10" 
                       max="500" 
                       step="5"
                       onchange="setZoom(parseInt(this.value) || 100)"
                       style="width: 70px; padding: 4px 8px; border: 1px solid #4b5563; border-radius: 4px; background: #1f2937; color: white; text-align: center;">
                <span style="color: white;">%</span>
                <button class="btn btn-secondary btn-sm" onclick="zoomIn()">ğŸ”+</button>
                
                <button class="btn btn-secondary btn-sm" onclick="showDayManager()">âš™ï¸ å¤©æ•°ç®¡ç†</button>
                <button class="btn btn-secondary btn-sm" onclick="showTagManager()">ğŸ·ï¸ æ ‡ç­¾ç®¡ç†</button>
                
                <button class="btn btn-success btn-sm" id="addEventBtn" onclick="showAddEventForm()" style="margin-left: auto; display: none;">â• æ·»åŠ äº‹ä»¶</button>
            </div>
            
            <div class="timeline-canvas" id="timelineCanvas">
                <div class="timeline-header" id="timelineHeader"></div>
                <div class="timeline-grid" id="timelineGrid"></div>
            </div>
            
            <div class="timeline-scale" id="timelineScale">
                <span id="scaleStart">åº5</span>
                <span id="scaleEnd">ç¬¬100ç« </span>
            </div>
            
            <div class="timeline-hint" id="timelineHint">
                ç‚¹å‡»äº‹ä»¶æŸ¥çœ‹è¯¦æƒ…
            </div>
        </div>
    </div>
    
    <!-- Event Detail Modal -->
    <div class="modal" id="eventDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="eventDetailTitle"></div>
                <button class="modal-close" onclick="closeEventDetail()">Ã—</button>
            </div>
            <div class="modal-body" id="eventDetailBody"></div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="editEvent()">âœï¸ ç¼–è¾‘</button>
                <button class="btn btn-danger" id="deleteEventBtn" onclick="deleteEvent()" style="display: none;">ğŸ—‘ï¸ åˆ é™¤</button>
            </div>
        </div>
    </div>
    
    <!-- Event Form Modal -->
    <div class="modal" id="eventFormModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="eventFormTitle">æ·»åŠ äº‹ä»¶</div>
                <button class="modal-close" onclick="closeEventForm()">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="form-group">
                        <label class="form-label">äº‹ä»¶æ ‡é¢˜</label>
                        <input type="text" class="form-input" id="eventTitle" placeholder="è¾“å…¥äº‹ä»¶æ ‡é¢˜">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è¯¦ç»†æè¿°</label>
                        <textarea class="form-textarea" id="eventDescription" placeholder="è¯¦ç»†æè¿°äº‹ä»¶å†…å®¹"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">èµ·å§‹ç« èŠ‚ï¼ˆç¬¬å‡ ç« ï¼‰</label>
                            <input type="number" class="form-input" id="eventStartTime" value="1" min="1" onchange="updateDayHint()">
                            <div class="hint" id="chapterHint">ä¿®æ”¹æ­¤å€¼å¯ä»¥æ”¹å˜äº‹ä»¶çš„èµ·å§‹ç« èŠ‚</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æŒç»­ç« èŠ‚ï¼ˆç« æ•°ï¼‰</label>
                            <input type="number" class="form-input" id="eventDuration" value="2" min="1">
                            <div class="hint">ä¿®æ”¹æ­¤å€¼å¯ä»¥æ”¹å˜äº‹ä»¶çš„é•¿åº¦</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è¡Œä½ç½®ï¼ˆlayerï¼‰</label>
                        <input type="number" class="form-input" id="eventLayer" value="0" min="0">
                        <div class="hint">æç¤ºï¼šè¡Œä½ç½®å†³å®šäº‹ä»¶çš„å‚ç›´ä½ç½®ï¼Œ0åœ¨æœ€ä¸Šæ–¹ï¼ˆç« èŠ‚èŒƒå›´å¤§çš„äº‹ä»¶å»ºè®®æ”¾åœ¨ä¸Šæ–¹ï¼‰                    
                    <div class="form-group">
                        <label class="form-label">äº‹ä»¶é¢œè‰²</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="color" class="form-input" id="eventColor" value="#3b82f6" style="width: 80px; height: 40px; cursor: pointer;">
                            <span id="colorPreview" style="flex: 1; padding: 10px; border-radius: 6px; background: #3b82f6; color: white; text-align: center; font-weight: bold;">é¢œè‰²é¢„è§ˆ</span>
                        </div>
                        <div class="hint">é€‰æ‹©æ­¤äº‹ä»¶åœ¨æ—¶é—´çº¿ä¸Šæ˜¾ç¤ºçš„é¢œè‰²</div>
                    </div>
</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ ‡ç­¾</label>
                        <div class="tag-list" id="eventTagsList"></div>
                        <div class="tag-input-group">
                            <input type="text" class="form-input" id="eventTagInput" placeholder="è¾“å…¥æ ‡ç­¾ï¼ŒæŒ‰å›è½¦æ·»åŠ ">
                            <button type="button" class="btn btn-primary btn-sm" onclick="addTag()">æ·»åŠ </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="showTagSelector()">ğŸ“‹ é€‰æ‹©</button>
                        </div>
                        <div id="tagSelectorDropdown" style="display: none; margin-top: 10px; max-height: 200px; overflow-y: auto; border: 2px solid #e5e7eb; border-radius: 6px; padding: 10px; background: white;">
                            <div style="font-weight: bold; margin-bottom: 8px; color: #6b7280; font-size: 12px;">ç‚¹å‡»æ ‡ç­¾æ·»åŠ åˆ°äº‹ä»¶</div>
                            <div id="availableTagsList"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEventForm()">âŒ å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveEvent()">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Day Manager Modal -->
    <div class="modal" id="chapterManagerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">âš™ï¸ å¤©æ•°ç®¡ç†</div>
                <button class="modal-close" onclick="closeDayManager()">Ã—</button>
            </div>
            <div class="modal-body">
                <div id="chapterList"></div>
                
                <div style="border-top: 2px solid #e5e7eb; margin-top: 20px; padding-top: 20px;">
                    <h3 style="font-weight: bold; margin-bottom: 15px; color: #111827;">æ·»åŠ æ–°å¤©æ•°</h3>
                    <div class="info-box" style="background: #e0f2fe; border: 1px solid #0284c7; margin-bottom: 15px;">
                        <p style="color: #0c4a6e; font-size: 13px; margin: 0;">
                            ğŸ’¡ <strong>æç¤ºï¼š</strong>ç« èŠ‚æ˜¾ç¤ºè§„åˆ™<br>
                            â€¢ è´Ÿæ•°æ˜¾ç¤ºä¸º"åºX"ï¼ˆ-5æ˜¾ç¤ºä¸º"åº5"ï¼‰<br>
                            â€¢ 0æ˜¾ç¤ºä¸º"åºç« "<br>
                            â€¢ æ­£æ•°æ˜¾ç¤ºä¸º"ç¬¬Xç« "ï¼ˆ5æ˜¾ç¤ºä¸º"ç¬¬5ç« "ï¼‰<br>
                            â€¢ æ”¯æŒå€’åºå†™ä½œï¼ˆå¦‚ç¬¬100ç« åˆ°ç¬¬90ç« ï¼‰<br>
                            â€¢ <strong style="color: #dc2626;">âš ï¸ ç« èŠ‚èŒƒå›´ä¸èƒ½é‡å </strong>
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¤©æ•°åç§°</label>
                        <input type="text" class="form-input" id="newChapterName" placeholder="ä¾‹å¦‚ï¼šç¬¬1å¤©">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">èµ·å§‹ç« èŠ‚</label>
                            <input type="number" class="form-input" id="newChapterStart" value="1">
                            <div class="hint">å¯ä»¥æ˜¯ä»»æ„æ•°å­—ï¼ˆæ”¯æŒè´Ÿæ•°ã€å€’åºï¼‰</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç»“æŸç« èŠ‚</label>
                            <input type="number" class="form-input" id="newChapterEnd" value="10">
                            <div class="hint">å¯ä»¥å°äºèµ·å§‹ç« èŠ‚ï¼ˆå€’åºå†™ä½œï¼‰</div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="addDay()" style="width: 100%;">â• æ·»åŠ å¤©æ•°</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDayManager()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- Tag Manager Modal -->
    <div class="modal" id="tagManagerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ·ï¸ æ ‡ç­¾ç®¡ç†</div>
                <button class="modal-close" onclick="closeTagManager()">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="border-bottom: 2px solid #e5e7eb; margin-bottom: 20px; padding-bottom: 20px;">
                    <h3 style="font-weight: bold; margin-bottom: 15px; color: #111827;">åˆ›å»ºæ–°æ ‡ç­¾</h3>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-input" id="newTagInput" placeholder="è¾“å…¥æ–°æ ‡ç­¾åç§°ï¼ˆè‡ªåŠ¨æ·»åŠ #ï¼‰" style="flex: 1;">
                        <button class="btn btn-success" onclick="createNewTag()">â• åˆ›å»ºæ ‡ç­¾</button>
                    </div>
                    <div class="hint" style="margin-top: 8px;">åˆ›å»ºçš„æ ‡ç­¾ä¼šè‡ªåŠ¨æ·»åŠ åˆ°æ ‡ç­¾åº“ä¸­</div>
                </div>
                
                <div id="tagManagerBody"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTagManager()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        let editMode = false;
        let zoom = 100;
        let selectedEvent = null;
        let editingEvent = null;
        let currentTags = [];
        let draggingEvent = null;
        let dragOffset = { x: 0, y: 0 };
        let hasDragged = false;
        let resizingEvent = null;
        
        // å…¨å±€æ ‡ç­¾åº“
        let globalTags = new Set();
        
        let events = [
            { id: 't1', title: 'è´¯ç©¿å…¨æ–‡', description: 'æ•´ä¸ªæ•…äº‹çš„æ ¸å¿ƒçº¿ï¼Œè´¯ç©¿å…¨æ–‡',
              startTime: 1, duration: 100, layer: 0, color: 'rgb(147, 51, 234)', tags: ['#å…¨å±€', '#ä¸»çº¿'] },
            { id: 't2', title: 'ç©¿è¶Šè§‰é†’', description: 'å‘¨æ˜ç‘ç©¿è¶Šåˆ°500åœ°çƒï¼Œè·å¾—ç³»ç»Ÿ',
              startTime: 1, duration: 2, layer: 1, color: 'rgb(59, 130, 246)', tags: ['#å¼€å±€', '#ç©¿è¶Š', '#å»·æ ¹'] },
            { id: 't3', title: 'äº‹ä»¶1', description: 'é€šè¿‡æµ‹è¯•ï¼Œæˆä¸ºå€¼å¤œè€…',
              startTime: 6, duration: 3, layer: 1, color: 'rgb(34, 197, 94)', tags: ['#å€¼å¤œè€…', '#å»·æ ¹'] },
            { id: 't4', title: 'äº‹ä»¶2', description: 'åœ¨ç°é›¾ä¹‹ä¸Šè·å¾—ä¸‰ä»¶å¥—',
              startTime: 4, duration: 2, layer: 2, color: 'rgb(168, 85, 247)', tags: ['#ä¸‰ä»¶å¥—', '#å”¯ä¸€æ€§', '#ç°é›¾'] },
            { id: 't5', title: 'å‰ä¸–å›å¿†', description: 'å‘¨æ˜ç‘ç©¿è¶Šå‰çš„è®°å¿†ç‰‡æ®µ',
              startTime: -3, duration: 3, layer: 1, color: 'rgb(107, 114, 128)', tags: ['#å›å¿†', '#å‰ä¸–'] }
        ];
        
        let days = [
            { id: 1, name: 'åºç« ç¯‡', startChapter: -5, endChapter: 0 },
            { id: 2, name: 'ç¬¬1å¤©', startChapter: 1, endChapter: 10 },
            { id: 3, name: 'ç¬¬2å¤©', startChapter: 11, endChapter: 20 },
            { id: 4, name: 'ç¬¬3å¤©', startChapter: 21, endChapter: 30 }
        ];
        
        // ç« èŠ‚å·æ ¼å¼åŒ–å‡½æ•°
        function formatChapter(num) {
            if (num < 0) {
                return `åº${-num}`;  // -5 æ˜¾ç¤ºä¸º "åº5"
            } else if (num === 0) {
                return 'åºç« ';
            } else {
                return `ç¬¬${num}ç« `;
            }
        }
        
        // ç« èŠ‚èŒƒå›´æ ¼å¼åŒ–
        function formatChapterRange(start, end) {
            return `${formatChapter(start)}-${formatChapter(end)}`;
        }
        
        // æ£€æŸ¥ç« èŠ‚èŒƒå›´æ˜¯å¦é‡å 
        function checkChapterOverlap(newStart, newEnd, excludeId = null) {
            const newMin = Math.min(newStart, newEnd);
            const newMax = Math.max(newStart, newEnd);
            
            for (let day of days) {
                if (excludeId !== null && day.id === excludeId) continue;
                
                const dayMin = Math.min(day.startChapter, day.endChapter);
                const dayMax = Math.max(day.startChapter, day.endChapter);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é‡å 
                if (!(newMax < dayMin || newMin > dayMax)) {
                    return {
                        overlap: true,
                        conflictDay: day
                    };
                }
            }
            
            return { overlap: false };
        }
        
        const defaultEventColor = 'rgb(59, 130, 246)';
        
        function init() {
            initializeGlobalTags();
            updateZoom();
            render();
            setupEventListeners();
        }
        

        // åˆå§‹åŒ–å…¨å±€æ ‡ç­¾åº“
        function initializeGlobalTags() {
            events.forEach(event => {
                if (event.tags) {
                    event.tags.forEach(tag => globalTags.add(tag));
                }
            });
        }
        
        // é¢œè‰²é€‰æ‹©å™¨äº‹ä»¶ç›‘å¬
        function setupColorPicker() {
            const colorInput = document.getElementById('eventColor');
            const colorPreview = document.getElementById('colorPreview');
            
            if (colorInput) {
                colorInput.addEventListener('input', (e) => {
                    const color = e.target.value;
                    colorPreview.style.background = color;
                    colorPreview.textContent = color.toUpperCase();
                });
            }
        }
        
        // åˆ›å»ºæ–°æ ‡ç­¾
        function createNewTag() {
            const input = document.getElementById('newTagInput');
            let tag = input.value.trim();
            
            if (!tag) {
                alert('è¯·è¾“å…¥æ ‡ç­¾åç§°');
                return;
            }
            
            // è‡ªåŠ¨æ·»åŠ #å·
            if (!tag.startsWith('#')) {
                tag = '#' + tag;
            }
            
            globalTags.add(tag);
            input.value = '';
            
            alert(`âœ… æ ‡ç­¾ "${tag}" å·²åˆ›å»ºï¼`);
            renderTagManager();
        }
        
        // æ˜¾ç¤ºæ ‡ç­¾é€‰æ‹©å™¨
        function showTagSelector() {
            const dropdown = document.getElementById('tagSelectorDropdown');
            const tagsList = document.getElementById('availableTagsList');
            
            if (dropdown.style.display === 'none') {
                // æ¸²æŸ“å¯ç”¨æ ‡ç­¾
                const availableTags = Array.from(globalTags).filter(tag => !currentTags.includes(tag));
                
                if (availableTags.length === 0) {
                    tagsList.innerHTML = '<div style="color: #6b7280; font-style: italic;">æš‚æ— å¯é€‰æ ‡ç­¾</div>';
                } else {
                    tagsList.innerHTML = availableTags.map(tag => `
                        <span class="tag-item" style="cursor: pointer; margin: 4px;" onclick="selectTagFromList('${tag}')">
                            ${tag}
                        </span>
                    `).join('');
                }
                
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        
        // ä»åˆ—è¡¨é€‰æ‹©æ ‡ç­¾
        function selectTagFromList(tag) {
            if (!currentTags.includes(tag)) {
                currentTags.push(tag);
                renderTagsList();
                showTagSelector(); // åˆ·æ–°åˆ—è¡¨
            }
        }
        
        // RGBè½¬åå…­è¿›åˆ¶
        function rgbToHex(rgb) {
            const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (!match) return '#3b82f6';
            
            const hex = (x) => {
                const h = parseInt(x).toString(16);
                return h.length === 1 ? '0' + h : h;
            };
            
            return '#' + hex(match[1]) + hex(match[2]) + hex(match[3]);
        }
        
        // åå…­è¿›åˆ¶è½¬RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? 
                `rgb(${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)})` :
                'rgb(59, 130, 246)';
        }

        function setupEventListeners() {
            document.getElementById('eventTagInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag();
                }
            });
            
            setupColorPicker();
        }
        
        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('editModeBtn');
            const addBtn = document.getElementById('addEventBtn');
            const hint = document.getElementById('timelineHint');
            
            if (editMode) {
                btn.textContent = 'âœ“ ç¼–è¾‘ä¸­';
                btn.className = 'btn btn-success';
                addBtn.style.display = 'block';
                hint.textContent = 'æ‹–åŠ¨äº‹ä»¶å¯æ”¹å˜ä½ç½®å’Œç« èŠ‚ï¼Œæ‹–åŠ¨å³è¾¹ç¼˜å¯è°ƒæ•´æŒç»­ç« èŠ‚æ•°';
            } else {
                btn.textContent = 'âœ ç¼–è¾‘';
                btn.className = 'btn btn-primary';
                addBtn.style.display = 'none';
                hint.textContent = 'ç‚¹å‡»äº‹ä»¶æŸ¥çœ‹è¯¦æƒ…';
            }
            
            render();
        }
        
        function zoomIn() {
            zoom = Math.min(500, zoom + 10);
            updateZoom();
        }
        
        function zoomOut() {
            zoom = Math.max(10, zoom - 10);
            updateZoom();
        }
        
        function setZoom(value) {
            zoom = Math.max(10, Math.min(500, value));
            updateZoom();
        }
        
        function updateZoom() {
            document.getElementById('zoomInput').value = zoom;
            render();
        }
        
        function render() {
            renderTimeline();
        }
        
        function renderTimeline() {
            const chapterWidth = (zoom / 100) * 50;
            
            // åŠ¨æ€è®¡ç®—æ—¶é—´çº¿èŒƒå›´
            const allChapters = [
                ...days.flatMap(d => [d.startChapter, d.endChapter]),
                ...events.flatMap(e => [e.startTime, e.startTime + e.duration])
            ];
            const minChapter = Math.min(...allChapters, 0);
            const maxChapter = Math.max(...allChapters, 100);
            const timelineWidth = (maxChapter - minChapter) * chapterWidth;
            
            const maxLayer = Math.max(...events.map(e => e.layer), 5);
            
            // Render header - æ˜¾ç¤ºå¤©æ•°
            const header = document.getElementById('timelineHeader');
            header.style.minWidth = timelineWidth + 'px';
            header.innerHTML = days.map(day => {
                const dayWidth = Math.abs(day.endChapter - day.startChapter) + 1;
                const leftPos = (Math.min(day.startChapter, day.endChapter) - minChapter) * chapterWidth;
                return `
                <div class="chapter-label" style="
                    position: absolute;
                    left: ${leftPos}px;
                    width: ${dayWidth * chapterWidth}px;
                ">
                    <div>${day.name}</div>
                    <div class="chapter-sublabel">${formatChapterRange(day.startChapter, day.endChapter)}</div>
                </div>
            `;
            }).join('');
            
            // Render events
            const grid = document.getElementById('timelineGrid');
            grid.style.minWidth = timelineWidth + 'px';
            grid.style.minHeight = (maxLayer + 1) * 80 + 100 + 'px';
            grid.innerHTML = events.map(event => {
                const left = (event.startTime - minChapter) * chapterWidth;
                const width = Math.max(event.duration * chapterWidth, 80);
                const top = event.layer * 80;
                
                return `
                    <div class="event-block ${editMode ? 'editable' : ''}" 
                         data-id="${event.id}"
                         data-min-chapter="${minChapter}"
                         style="
                            left: ${left}px;
                            width: ${width}px;
                            top: ${top}px;
                            background-color: ${event.color};
                         ">
                        <div class="event-title">${event.title}</div>
                        <div class="event-time">${formatChapterRange(event.startTime, event.startTime + event.duration)}</div>
                        ${event.tags ? `
                            <div class="event-tags">
                                ${event.tags.slice(0, 2).map(tag => `
                                    <span class="event-tag">${tag}</span>
                                `).join('')}
                            </div>
                        ` : ''}
                        <div class="resize-handle" data-id="${event.id}"></div>
                    </div>
                `;
            }).join('');
            
            // Update scale
            document.getElementById('scaleStart').textContent = formatChapter(minChapter);
            document.getElementById('scaleEnd').textContent = formatChapter(maxChapter);
            
            // Add drag event listeners
            document.querySelectorAll('.event-block').forEach(block => {
                block.addEventListener('mousedown', (e) => {
                    if (!e.target.classList.contains('resize-handle')) {
                        startDrag(e);
                    }
                });
                block.addEventListener('click', (e) => {
                    if (!hasDragged && !e.target.classList.contains('resize-handle')) {
                        showEventDetail(block.dataset.id);
                    }
                    hasDragged = false;
                });
            });
            
            // Add resize event listeners
            document.querySelectorAll('.resize-handle').forEach(handle => {
                handle.addEventListener('mousedown', (e) => startResize(e));
            });
        }
        
        function startDrag(e) {
            if (!editMode) return;
            e.preventDefault();
            
            const block = e.currentTarget;
            const id = block.dataset.id;
            const event = events.find(ev => ev.id === id);
            if (!event) return;
            
            hasDragged = false;
            draggingEvent = event;
            const rect = block.getBoundingClientRect();
            const canvas = document.getElementById('timelineCanvas');
            const canvasRect = canvas.getBoundingClientRect();
            
            dragOffset = {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
            
            block.classList.add('dragging');
            
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', endDrag);
        }
        
        function onDrag(e) {
            if (!draggingEvent) return;
            e.preventDefault();
            
            hasDragged = true;
            
            const canvas = document.getElementById('timelineCanvas');
            const canvasRect = canvas.getBoundingClientRect();
            const chapterWidth = (zoom / 100) * 50;
            
            // è·å–æœ€å°ç« èŠ‚åç§»
            const block = document.querySelector(`[data-id="${draggingEvent.id}"]`);
            const minChapter = parseInt(block?.dataset.minChapter || 0);
            
            const x = e.clientX - canvasRect.left + canvas.scrollLeft - dragOffset.x;
            const y = e.clientY - canvasRect.top + canvas.scrollTop - dragOffset.y;
            
            const newStartTime = Math.round(x / chapterWidth) + minChapter;
            const newLayer = Math.max(0, Math.round(y / 80));
            
            draggingEvent.startTime = newStartTime;
            draggingEvent.layer = newLayer;
            
            if (block) {
                block.style.left = ((newStartTime - minChapter) * chapterWidth) + 'px';
                block.style.top = (newLayer * 80) + 'px';
            }
        }
        
        function endDrag(e) {
            if (!draggingEvent) return;
            
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', endDrag);
            
            const collision = checkCollision(draggingEvent);
            if (collision) {
                const freeLayer = findFreeLayer(draggingEvent.startTime, draggingEvent.duration, draggingEvent.id);
                draggingEvent.layer = freeLayer;
            }
            
            const block = document.querySelector(`[data-id="${draggingEvent.id}"]`);
            if (block) {
                block.classList.remove('dragging');
            }
            
            draggingEvent = null;
            render();
        }
        
        function checkCollision(event) {
            const eventEnd = event.startTime + event.duration;
            
            for (let other of events) {
                if (other.id === event.id) continue;
                
                const otherEnd = other.startTime + other.duration;
                const timeOverlap = !(eventEnd <= other.startTime || event.startTime >= otherEnd);
                const layerOverlap = event.layer === other.layer;
                
                if (timeOverlap && layerOverlap) {
                    return other;
                }
            }
            
            return null;
        }
        
        function findFreeLayer(startTime, duration, excludeId) {
            const eventEnd = startTime + duration;
            
            for (let layer = 0; layer < 20; layer++) {
                let isFree = true;
                
                for (let other of events) {
                    if (other.id === excludeId) continue;
                    if (other.layer !== layer) continue;
                    
                    const otherEnd = other.startTime + other.duration;
                    const timeOverlap = !(eventEnd <= other.startTime || startTime >= otherEnd);
                    
                    if (timeOverlap) {
                        isFree = false;
                        break;
                    }
                }
                
                if (isFree) {
                    return layer;
                }
            }
            
            return 0;
        }
        
        function startResize(e) {
            if (!editMode) return;
            e.preventDefault();
            e.stopPropagation();
            
            const handle = e.target;
            const id = handle.dataset.id;
            const event = events.find(ev => ev.id === id);
            if (!event) return;
            
            resizingEvent = event;
            
            document.addEventListener('mousemove', onResize);
            document.addEventListener('mouseup', endResize);
        }
        
        function onResize(e) {
            if (!resizingEvent) return;
            e.preventDefault();
            
            const canvas = document.getElementById('timelineCanvas');
            const canvasRect = canvas.getBoundingClientRect();
            const dayWidth = (zoom / 100) * 50;
            
            const block = document.querySelector(`[data-id="${resizingEvent.id}"]`);
            if (!block) return;
            
            const blockRect = block.getBoundingClientRect();
            const blockLeft = blockRect.left - canvasRect.left + canvas.scrollLeft;
            
            const mouseX = e.clientX - canvasRect.left + canvas.scrollLeft;
            const newWidth = mouseX - blockLeft;
            const newDuration = Math.max(1, Math.round(newWidth / dayWidth));
            
            resizingEvent.duration = newDuration;
            block.style.width = Math.max(newDuration * dayWidth, 80) + 'px';
            
            const timeDisplay = block.querySelector('.event-time');
            if (timeDisplay) {
                timeDisplay.textContent = `ç¬¬${resizingEvent.startTime}-${resizingEvent.startTime + resizingEvent.duration}å¤©`;
            }
        }
        
        function endResize(e) {
            if (!resizingEvent) return;
            
            document.removeEventListener('mousemove', onResize);
            document.removeEventListener('mouseup', endResize);
            
            resizingEvent = null;
            render();
        }
        
        function showEventDetail(id) {
            const event = events.find(e => e.id === id);
            if (!event) return;
            
            selectedEvent = event;
            const modal = document.getElementById('eventDetailModal');
            
            const day = days.find(d => {
                const min = Math.min(d.startChapter, d.endChapter);
                const max = Math.max(d.startChapter, d.endChapter);
                return event.startTime >= min && event.startTime <= max;
            });
            const dayName = day ? day.name : 'æœªåˆ†é…';
            
            document.getElementById('eventDetailTitle').textContent = event.title;
            document.getElementById('eventDetailBody').innerHTML = `
                <div class="info-box">
                    <h3>ğŸ“ æè¿°</h3>
                    <p>${event.description}</p>
                </div>
                <div class="info-box">
                    <h3>â±ï¸ æ—¶é—´ä¿¡æ¯</h3>
                    <p><strong>æ‰€å±å¤©æ•°ï¼š</strong>${dayName}</p>
                    <p><strong>èµ·å§‹ï¼š</strong>${formatChapter(event.startTime)}</p>
                    <p><strong>æŒç»­ï¼š</strong>${event.duration}ç« </p>
                    <p><strong>ç»“æŸï¼š</strong>${formatChapter(event.startTime + event.duration)}</p>
                    <p><strong>æ‰€åœ¨è¡Œä½ç½®ï¼š</strong>ç¬¬${event.layer}è¡Œ</p>
                </div>
                ${event.tags && event.tags.length > 0 ? `
                    <div class="info-box">
                        <h3>ğŸ·ï¸ æ ‡ç­¾</h3>
                        <div class="tag-list">
                            ${event.tags.map(tag => `<span class="tag-item">${tag}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
            
            const deleteBtn = document.getElementById('deleteEventBtn');
            if (deleteBtn) {
                deleteBtn.style.display = editMode ? 'block' : 'none';
            }
            
            modal.classList.add('show');
        }
        
        function closeEventDetail() {
            document.getElementById('eventDetailModal').classList.remove('show');
            selectedEvent = null;
        }
        
        function showAddEventForm() {
            editingEvent = null;
            currentTags = [];
            document.getElementById('eventFormTitle').textContent = 'â• æ·»åŠ äº‹ä»¶';
            document.getElementById('eventForm').reset();
            document.getElementById('eventTagsList').innerHTML = '';
            document.getElementById('eventFormModal').classList.add('show');
            updateDayHint();
        }
        
        function editEvent() {
            if (!selectedEvent) return;
            editingEvent = selectedEvent;
            currentTags = [...(selectedEvent.tags || [])];
            
            document.getElementById('eventFormTitle').textContent = 'âœï¸ ç¼–è¾‘äº‹ä»¶';
            document.getElementById('eventTitle').value = selectedEvent.title;
            document.getElementById('eventDescription').value = selectedEvent.description;
            document.getElementById('eventStartTime').value = selectedEvent.startTime;
            document.getElementById('eventDuration').value = selectedEvent.duration;
            document.getElementById('eventLayer').value = selectedEvent.layer;
            
            // è®¾ç½®é¢œè‰²é€‰æ‹©å™¨
            const hexColor = rgbToHex(selectedEvent.color || 'rgb(59, 130, 246)');
            const colorInput = document.getElementById('eventColor');
            const colorPreview = document.getElementById('colorPreview');
            if (colorInput) {
                colorInput.value = hexColor;
                colorPreview.style.background = hexColor;
                colorPreview.textContent = hexColor.toUpperCase();
            }
            
            
            renderTagsList();
            closeEventDetail();
            document.getElementById('eventFormModal').classList.add('show');
            updateDayHint();
        }
        
        function closeEventForm() {
            document.getElementById('eventFormModal').classList.remove('show');
            editingEvent = null;
            currentTags = [];
        }
        
        function addTag() {
            const input = document.getElementById('eventTagInput');
            const tag = input.value.trim();
            if (!tag) return;
            
            const formattedTag = tag.startsWith('#') ? tag : '#' + tag;
            
            // æ·»åŠ åˆ°å…¨å±€æ ‡ç­¾åº“
            globalTags.add(formattedTag);
            if (!currentTags.includes(formattedTag)) {
                currentTags.push(formattedTag);
                renderTagsList();
            }
            input.value = '';
        }
        
        function removeTag(tag) {
            currentTags = currentTags.filter(t => t !== tag);
            renderTagsList();
        }
        
        function renderTagsList() {
            const container = document.getElementById('eventTagsList');
            container.innerHTML = currentTags.map(tag => `
                <span class="tag-item">
                    ${tag}
                    <button class="tag-remove" onclick="removeTag('${tag}')">Ã—</button>
                </span>
            `).join('');
        }
        
        function saveEvent() {
            const title = document.getElementById('eventTitle').value.trim();
            const description = document.getElementById('eventDescription').value.trim();
            const startTime = parseInt(document.getElementById('eventStartTime').value);
            const duration = parseInt(document.getElementById('eventDuration').value) || 1;
            const layer = parseInt(document.getElementById('eventLayer').value) || 0;
            
            // è·å–é¢œè‰²
            const colorHex = document.getElementById('eventColor').value;
            const color = hexToRgb(colorHex);
            
            if (!title) {
                alert('è¯·è¾“å…¥äº‹ä»¶æ ‡é¢˜');
                return;
            }
            
            if (isNaN(startTime)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„èµ·å§‹ç« èŠ‚');
                return;
            }
            
            const eventData = {
                title,
                description,
                startTime,
                duration,
                layer,
                color: color,
                tags: currentTags
            };
            
            if (editingEvent) {
                Object.assign(editingEvent, eventData);
                alert('âœ… äº‹ä»¶ç¼–è¾‘æˆåŠŸï¼');
            } else {
                const maxId = Math.max(...events.map(e => parseInt(e.id.slice(1))), 0);
                eventData.id = 't' + (maxId + 1);
                events.push(eventData);
                alert('âœ… äº‹ä»¶æ·»åŠ æˆåŠŸï¼');
            }
            
            closeEventForm();
            render();
        }
        
        function deleteEvent() {
            if (!selectedEvent) return;
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤äº‹ä»¶å—ï¼Ÿ')) return;
            
            events = events.filter(e => e.id !== selectedEvent.id);
            closeEventDetail();
            render();
            alert('âœ… äº‹ä»¶åˆ é™¤æˆåŠŸï¼');
        }
        
        function exportData() {
            const data = {
                events: events,
                days: days,
                exportTime: new Date().toLocaleString('zh-CN')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æ•…äº‹å¤§çº²_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('âœ… å¯¼å‡ºæˆåŠŸï¼');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.events) events = data.events;
                    if (data.days) days = data.days;
                    // å…¼å®¹æ—§æ ¼å¼
                    if (data.chapters && !data.days) {
                        days = data.chapters.map(c => ({
                            id: c.id,
                            name: c.name,
                            startChapter: c.startDay,
                            endChapter: c.endDay
                        }));
                    }
                    render();
                    alert('âœ… å¯¼å…¥æˆåŠŸï¼');
                } catch (err) {
                    alert('âŒ å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function updateDayHint() {
            const startChapter = parseInt(document.getElementById('eventStartTime').value);
            if (isNaN(startChapter)) {
                document.getElementById('chapterHint').textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç« èŠ‚å·';
                return;
            }
            
            const day = days.find(d => {
                const min = Math.min(d.startChapter, d.endChapter);
                const max = Math.max(d.startChapter, d.endChapter);
                return startChapter >= min && startChapter <= max;
            });
            const dayName = day ? day.name : 'æœªåˆ†é…åˆ°ä»»ä½•å¤©æ•°';
            document.getElementById('chapterHint').textContent = `å½“å‰å°†å±äºï¼š${dayName}`;
        }
        
        function showDayManager() {
            const modal = document.getElementById('chapterManagerModal');
            renderDayList();
            modal.classList.add('show');
        }
        
        function closeDayManager() {
            document.getElementById('chapterManagerModal').classList.remove('show');
        }
        
        function renderDayList() {
            const container = document.getElementById('chapterList');
            container.innerHTML = days.map(day => {
                const chapterCount = Math.abs(day.endChapter - day.startChapter) + 1;
                return `
                <div class="chapter-item" id="chapter-${day.id}">
                    <div class="chapter-item-view">
                        <div class="chapter-info">
                            <h4>${day.name}</h4>
                            <p>${formatChapterRange(day.startChapter, day.endChapter)}ï¼ˆå…±${chapterCount}ç« ï¼‰</p>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary btn-sm" onclick="editDay(${day.id})">âœï¸ ç¼–è¾‘</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteDay(${day.id})">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="chapter-item-edit">
                        <div class="form-group">
                            <label class="form-label">å¤©æ•°åç§°</label>
                            <input type="text" class="form-input" id="editChapterName-${day.id}" value="${day.name}">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">èµ·å§‹ç« èŠ‚</label>
                                <input type="number" class="form-input" id="editChapterStart-${day.id}" value="${day.startChapter}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ç»“æŸç« èŠ‚</label>
                                <input type="number" class="form-input" id="editChapterEnd-${day.id}" value="${day.endChapter}">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-secondary btn-sm" onclick="cancelEditDay(${day.id})">âŒ å–æ¶ˆ</button>
                            <button class="btn btn-primary btn-sm" onclick="saveDay(${day.id})">ğŸ’¾ ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        function editDay(id) {
            const item = document.getElementById(`chapter-${id}`);
            if (item) {
                item.classList.add('editing');
            }
        }
        
        function cancelEditDay(id) {
            const item = document.getElementById(`chapter-${id}`);
            if (item) {
                item.classList.remove('editing');
            }
        }
        
        function saveDay(id) {
            const name = document.getElementById(`editChapterName-${id}`).value.trim();
            const startChapter = parseInt(document.getElementById(`editChapterStart-${id}`).value);
            const endChapter = parseInt(document.getElementById(`editChapterEnd-${id}`).value);
            
            if (!name) {
                alert('âŒ è¯·è¾“å…¥å¤©æ•°åç§°');
                return;
            }
            
            if (isNaN(startChapter) || isNaN(endChapter)) {
                alert('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„ç« èŠ‚å·');
                return;
            }
            
            if (endChapter <= startChapter) {
                alert(`âŒ ç»“æŸç« èŠ‚å¿…é¡»å¤§äºèµ·å§‹ç« èŠ‚ï¼\n\nå½“å‰è®¾ç½®ï¼š${formatChapter(startChapter)} - ${formatChapter(endChapter)}\n\nè¯·ä¿®æ”¹ä¸ºï¼šç»“æŸç« èŠ‚ > èµ·å§‹ç« èŠ‚\nä¾‹å¦‚ï¼š${formatChapter(startChapter)} - ${formatChapter(startChapter + 10)}`);
                return;
            }
            
            // æ£€æŸ¥ç« èŠ‚èŒƒå›´é‡å 
            const overlapCheck = checkChapterOverlap(startChapter, endChapter, id);
            if (overlapCheck.overlap) {
                alert(`âŒ ç« èŠ‚èŒƒå›´ä¸ã€Œ${overlapCheck.conflictDay.name}ã€é‡å ï¼\n\n` +
                      `${overlapCheck.conflictDay.name}: ${formatChapterRange(overlapCheck.conflictDay.startChapter, overlapCheck.conflictDay.endChapter)}\n` +
                      `å½“å‰è®¾ç½®: ${formatChapterRange(startChapter, endChapter)}\n\n` +
                      `è¯·è°ƒæ•´ç« èŠ‚èŒƒå›´ï¼Œé¿å…é‡å ã€‚`);
                return;
            }
            
            const day = days.find(d => d.id === id);
            if (day) {
                day.name = name;
                day.startChapter = startChapter;
                day.endChapter = endChapter;
            }
            
            renderDayList();
            render();
            alert('âœ… å¤©æ•°ä¿®æ”¹æˆåŠŸï¼');
        }
        
        function deleteDay(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤å¤©æ•°å—ï¼Ÿ')) return;
            
            days = days.filter(d => d.id !== id);
            renderDayList();
            render();
            alert('âœ… å¤©æ•°åˆ é™¤æˆåŠŸï¼');
        }
        
        function addDay() {
            const name = document.getElementById('newChapterName').value.trim();
            const startChapter = parseInt(document.getElementById('newChapterStart').value) || 0;
            const endChapter = parseInt(document.getElementById('newChapterEnd').value) || 0;
            
            if (!name) {
                alert('è¯·è¾“å…¥å¤©æ•°åç§°');
                return;
            }
            
            // æ£€æŸ¥ç« èŠ‚èŒƒå›´é‡å 
            const overlapCheck = checkChapterOverlap(startChapter, endChapter);
            if (overlapCheck.overlap) {
                alert(`âŒ ç« èŠ‚èŒƒå›´ä¸ã€Œ${overlapCheck.conflictDay.name}ã€é‡å ï¼\n\n` +
                      `${overlapCheck.conflictDay.name}: ${formatChapterRange(overlapCheck.conflictDay.startChapter, overlapCheck.conflictDay.endChapter)}\n` +
                      `å½“å‰è®¾ç½®: ${formatChapterRange(startChapter, endChapter)}\n\n` +
                      `è¯·è°ƒæ•´ç« èŠ‚èŒƒå›´ï¼Œé¿å…é‡å ã€‚ä¾‹å¦‚ï¼š\n` +
                      `â€¢ åœ¨å‰é¢ï¼š${formatChapter(Math.min(overlapCheck.conflictDay.startChapter, overlapCheck.conflictDay.endChapter) - 10)}-${formatChapter(Math.min(overlapCheck.conflictDay.startChapter, overlapCheck.conflictDay.endChapter) - 1)}\n` +
                      `â€¢ åœ¨åé¢ï¼š${formatChapter(Math.max(overlapCheck.conflictDay.startChapter, overlapCheck.conflictDay.endChapter) + 1)}-${formatChapter(Math.max(overlapCheck.conflictDay.startChapter, overlapCheck.conflictDay.endChapter) + 10)}`);
                return;
            }
            
            const maxId = Math.max(...days.map(d => d.id), 0);
            days.push({
                id: maxId + 1,
                name,
                startChapter,
                endChapter
            });
            
            document.getElementById('newChapterName').value = '';
            document.getElementById('newChapterStart').value = '1';
            document.getElementById('newChapterEnd').value = '10';
            
            renderDayList();
            render();
            alert('âœ… å¤©æ•°æ·»åŠ æˆåŠŸï¼');
        }
        
        function showTagManager() {
            const modal = document.getElementById('tagManagerModal');
            renderTagManager();
            modal.classList.add('show');
        }
        
        function closeTagManager() {
            document.getElementById('tagManagerModal').classList.remove('show');
        }
        
        function renderTagManager() {
            const tagMap = new Map();
            events.forEach(event => {
                if (event.tags) {
                    event.tags.forEach(tag => {
                        if (!tagMap.has(tag)) {
                            tagMap.set(tag, []);
                        }
                        tagMap.get(tag).push(event);
                    });
                }
            });
            
            // åˆå¹¶å…¨å±€æ ‡ç­¾åº“ä¸­çš„æ ‡ç­¾
            globalTags.forEach(tag => {
                if (!tagMap.has(tag)) {
                    tagMap.set(tag, []);
                }
            });
            
            const tags = Array.from(tagMap.entries()).sort((a, b) => b[1].length - a[1].length);
            
            const container = document.getElementById('tagManagerBody');
            
            if (tags.length === 0) {
                container.innerHTML = '<div class="info-box"><p>æš‚æ— æ ‡ç­¾ï¼Œè¯·å…ˆåˆ›å»ºæ ‡ç­¾</p></div>';
                return;
            }
            
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p class="hint">å…±æœ‰ ${tags.length} ä¸ªæ ‡ç­¾ï¼Œç‚¹å‡»æ ‡ç­¾æŸ¥çœ‹ä½¿ç”¨è¯¥æ ‡ç­¾çš„äº‹ä»¶</p>
                </div>
                ${tags.map(([tag, events]) => `
                    <div class="tag-stat-item">
                        <div class="tag-stat-header">
                            <span class="tag-stat-name">${tag}</span>
                            <span class="tag-stat-count">${events.length} ä¸ªäº‹ä»¶</span>
                        </div>
                        ${events.length > 0 ? `
                            <div class="tag-stat-events">
                                ${events.map(e => e.title).join('ã€')}
                            </div>
                        ` : '<div class="tag-stat-events" style="font-style: italic; color: #9ca3af;">æœªä½¿ç”¨</div>'}
                    </div>
                `).join('')}
            `;
        }
        
        // Initialize app
        init();
    </script>
</body>
</html>